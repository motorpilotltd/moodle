define(["jquery","theme_arupboost/repository","core/custom_interaction_events","theme_arupboost/imagehandler_cropworker"],function(a,b,c,d){var e=function(b,c,d){var e=M.util.get_string("closebuttontitle","moodle");a(c).length||b.find("#uploadbutton").before('<div id="'+c+'" class="alert alert-warning state-element state1" role="alert">'+d+'<button type="button" class="close" data-dismiss="alert" aria-label="'+e+'"><span aria-hidden="true">&times;</span></button></div>')},f=function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]},g=function(a){a.removeClass("state0"),a.removeClass("state1"),a.removeClass("state2"),a.removeClass("state3"),a.removeClass("state4"),a.find('[role="alert"]').remove()},h=function(a){g(a),a.addClass("state1")},i=function(a){g(a),a.addClass("state2")},j=function(a){g(a),a.addClass("state3")},k=function(g,k,l){g.data("servercoverfile",g.css("background-image"));var m,n;c.define(g,[c.events.activate]),g.on(c.events.activate,'[data-action="cropimage"]',function(a){j(g);var c=g.attr("data-original"),e=g.width()/100*90,f=g.height()/100*90,i=new d(g[0],{enableExif:!0,viewport:{width:e,height:f,type:"square"}});i.bind({url:c});var k=g.find('[data-action="crop-confirm"]');k.on("click",function(){i.result("base64").then(function(a){l.imagedata=a.split("base64,")[1],l.imagefilename=c,l.cropped=1,b.saveImage({params:l}).then(function(b){b.success&&(h(g),g.css("background-image","url("+a+")"),i.destroy(),location.reload())})})});var m=g.find('[data-action="crop-cancel"]');m.on("click",function(){i.destroy(),h(g)}),a.preventDefault()}),g.find(".input-coverfiles").on("change",function(b){var c=b.target.files;if(c.length&&(m=c[0],m.type.match("image.*"))){var d=new FileReader;g.find('label[for="imagehandler-coverfiles"]').addClass("ajaxing"),d.onload=function(b){return function(c){n=c.target.result;var d=k;if(b.size>d){h(g);var j=f(d),l=M.util.get_string("error:coverimageexceedsmaxbytes","theme_arupboost",j);return void e(g,"imagehandler-alert-cover-image-bytes",l)}g.find("#imagehandler-alert-cover-image-bytes").remove();var m=a("<img />");m=m.get(0),m.src=n,a(m).on("load",function(){m.width<400?e(g,"imagehandler-alert-cover-image-size",M.util.get_string("error:coverimageresolutionlow","theme_arupboost")):g.find("#imagehandler-alert-cover-image-size").remove()}),g.css("background-image","url("+n+")"),g.data("localcoverfile",b.name),i(g)}}(m),d.readAsDataURL(m)}}),g.find("#imagehandler-changecoverimageconfirmation .ok").click(function(c){if(!a(this).parent().hasClass("disabled")){c.preventDefault(),g.find("#imagehandler-alert-cover-image-size").remove(),g.find("#imagehandler-alert-cover-image-bytes").remove(),g.find("#imagehandler-changecoverimageconfirmation .ok").addClass("ajaxing"),g.find("#imagehandler-changecoverimageconfirmation").addClass("disabled");var d=n.split("base64,")[1];l.imagedata=d,l.imagefilename=m.name,l.cropped=0,b.saveImage({params:l}).then(function(a){a.success&&(h(g),g.attr("data-original",a.fileurl),location.reload())})}}),g.find("#imagehandler-changecoverimageconfirmation .cancel").click(function(){a(this).parent().hasClass("disabled")||(g.css("background-image",g.data("servercoverfile")),h(g))}),g.find(".uploadimagecontrols").addClass("imagehandler-js-enabled")},l=function(a,b){var c={imagefilename:null,imagedata:null,imageid:a.attr("data-imageid"),type:a.attr("data-type")};k(a,b,c)};return{updateImage:l}});