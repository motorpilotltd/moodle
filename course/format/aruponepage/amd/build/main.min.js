define(["jquery","format_aruponepage/sortable_list","core/notification","core/custom_interaction_events","core/ajax","core/str","core/templates"],function(a,b,c,d,e,f,g){var h={SECTION_CONTAINER:'[data-region="section-container"]',SECTION:'[data-region="section"]',MODULES_CONTAINER:'[data-region="course-modules"]',MODULE:'[data-region="module"]',COMPLETIONCHECKS:'[data-region="completioncheck"]',COMPLETION_CONTAINER:'[data-actions="availability"]',COMPLETION_INFO:'[data-region="availabilityinfo"]',SECTIONNAV_CONTAINER:'[data-region="sectionnav-control"]',SHOW_SECTIONS:'[data-action="show-sections"]',CLOSE_SECTIONNAV:'[data-action="close-nav"]',SECTIONNAV:'[data-region="sectionnav"]'},i=function(a){var b={methodname:"format_aruponepage_move_section",args:a},d=e.call([b])[0];return d.fail(c.exception),d},j=function(a){var b={methodname:"format_aruponepage_move_module",args:a},d=e.call([b])[0];return d.fail(c.exception),d},k=function(a){var b={methodname:"format_aruponepage_module_completion",args:a},d=e.call([b])[0];return d.fail(c.exception),d},l=function(a,b,c){var d=a.find("#sectionprogress-"+b),e=d.attr("data-completed-modules"),g=d.attr("data-completion-modules");1===c?e++:e--;var h=100*(e/g);f.get_string("section_completion","format_aruponepage",h).done(function(a){d.attr("title",a),d.attr("data-completed-modules",e),d.css("width",h+"%")})},m=function(e){d.define(e,[d.events.activate]);var m=a(h.SECTIONNAV_CONTAINER),n=a(h.SECTIONNAV);d.define(m,[d.events.activate]),m.on(d.events.activate,h.SHOW_SECTIONS,function(){n.addClass("shownav")}),d.define(n,[d.events.activate]),n.on(d.events.activate,h.CLOSE_SECTIONNAV,function(){n.removeClass("shownav")}),e.on(d.events.activate,h.COMPLETIONCHECKS,function(b){var d=a(b.target).closest(h.COMPLETIONCHECKS),f=parseInt(d.attr("data-module")),i=parseInt(d.attr("data-targetstate")),j=parseInt(d.attr("data-courseid")),m=parseInt(d.attr("data-sectionnumber")),n=parseInt(d.attr("data-reloadonchange")),o={moduleid:f,targetstate:i,courseid:j};k(o).then(function(a){return n&&window.location.reload(),l(e,m,i),g.replaceNode(d,a.completionicon,""),null}).fail(c.exception)});var o=e.find(h.SECTION_CONTAINER),p=e.find(h.SECTION),q=o.attr("data-courseid"),r=function(a){return a.find("h3.sectionname .inplaceeditable").text()},s=function(a){return a.find(".cmname .inplaceeditable").text()},t=function(a){return a.closest('[data-region="section"][data-sectionnumber]')},u=new b(o,{moveHandlerSelector:".movesection > [data-drag-type=move]"});u.getElementName=function(b){return a.Deferred().resolve(r(b))};var v=e.find(h.MODULES_CONTAINER),w=new b(v,{moveHandlerSelector:".movemodule > [data-drag-type=move]"});w.getElementName=function(b){return a.Deferred().resolve(s(b))},w.getDestinationName=function(b,c){return c.length?0===a(c).find(".cmname").length?null:f.get_string("movecontentafter","moodle",s(c)):f.get_string("totopofsection","moodle",r(t(b)))},p.on(b.EVENTS.DROP,function(a,b){a.stopPropagation();var d,e;if(b.positionChanged){if(b.element.attr("data-sectionnumber")){if(b.targetNextElement&&"0"===b.targetNextElement.attr("data-sectionnumber"))return void u.moveElement(b.sourceList,b.sourceNextElement);d=b.element.attr("data-sectionnumber");var f=b.targetNextElement.attr("data-sectionnumber");e={sectionnumber:d,sectiontarget:f,courseid:q},i(e).then(function(){return b.element.attr("data-sectionnumber",f),b.targetNextElement.attr("data-sectionnumber",d),null})["catch"](c.exception)}if(b.element.attr("data-module")){var g=b.element.attr("data-module"),h=b.targetNextElement.attr("data-module");d=t(b.targetList).attr("data-sectionnumber"),e={moduleid:g,moduletarget:h,sectionnumber:d,courseid:q},"undefined"!=typeof g&&0!==g&&j(e)["catch"](c.exception)}}});var x=function(){e.find(h.SECTION).each(function(){var b=a(this).find(h.MODULES_CONTAINER),c=b.children().length-1;b.attr("data-nummodules",c),0===c?b.addClass("nomodules"):b.removeClass("nomodules")})};x(),p.on(b.EVENTS.DRAG,function(b,c){if(c.element.attr("data-module")){e.find(h.SECTION).each(function(){a(this).removeClass("movemodule")});var d=t(c.sourceList).find(h.MODULES_CONTAINER),f=parseInt(d.attr("data-nummodules"));1===f&&d.addClass("nomodules");var g=t(c.targetList);g.addClass("movemodule")}}),p.on(b.EVENTS.DRAGEND,function(a,b){b.element.attr("data-module")&&x()})},n=function(b){b=a(b),m(b)};return{init:n}});