define(["jquery","core/templates","core/modal_factory","core/modal_events"],function(a,b,c,d){var e={config:{},loadingimg:"",deleteicon:"",upicon:"",downicon:"",spacer:"",filterselector:"div.filter_selector select, select.filter_selector",newfilterselector:"div.new_standard_filter_selector select, div.new_sidebar_filter_selector select, select.new_standard_filter_selector, select.new_sidebar_filter_selector",filternametextselector:"div.filter_name_text input, input.filter_name_text",searchcolumnselectselector:"div.search_column_selector select, select.search_column_selector",customnamecheckselector:"div.filter_custom_name_checkbox input, input.filter_custom_name_checkbox",advcheckselector:"div.filter_advanced_checkbox input, input.filter_advanced_checkbox",newsearchcolumnselector:"div.new_search_column_selector select, select.new_search_column_selector",notnewfilterselector:'div.filter_selector select:not(.new_standard_filter_selector, [name="new_standard_filter_selector"]), select.filter_selector:not(.new_standard_filter_selector, [name="new_standard_filter_selector"])',init:function(c){if(c){var d=a.parseJSON(c);for(var e in d)this.config[e]=d[e]}var f=this,g=[];g.push(b.renderPix("i/loading","core",M.util.get_string("saving","local_reportbuilder"))),g.push(b.renderPix("t/delete","core",M.util.get_string("delete","local_reportbuilder"))),g.push(b.renderPix("t/up","core",M.util.get_string("moveup","local_reportbuilder"))),g.push(b.renderPix("t/down","core",M.util.get_string("movedown","local_reportbuilder"))),g.push(b.renderPix("spacer","")),a.when.apply(a,g).then(function(a,b,c,d,e){f.loadingimg=a,f.deleteicon=b,f.upicon=c,f.downicon=d,f.spacer=e,f.rb_init_filter_rows(),f.rb_init_search_column_rows()})},rb_init_filter_rows:function(){var b=this;a("#id_newstandardcustomname").prop("disabled",!0),a("#id_newsidebarcustomname").prop("disabled",!0),a(e.customnamecheckselector).not(":checked").each(function(){var b=a(e.filternametextselector,a(this).parents("tr:first"));b.prop("disabled",!0)}),a(e.advcheckselector).off("click"),a(e.advcheckselector).on("click",function(){window.onbeforeunload=null}),a(e.filterselector).off("change"),a(e.filterselector).on("change",function(){window.onbeforeunload=null;var c=a(this).val(),d=b.config.rb_filter_headings[c],f=a(e.filternametextselector,a(this).parents("tr:first"));f.val(d)}),a(e.customnamecheckselector).off("click"),a(e.customnamecheckselector).on("click",function(){window.onbeforeunload=null;var c=a(e.filternametextselector,a(this).parents("tr:first"));if(a(this).is(":checked"))c.prop("disabled",!1);else{c.prop("disabled",!0);var d=a(e.filterselector,a(this).parents("tr:first")).val(),f=b.config.rb_filter_headings[d];c.val(f)}}),a(e.newfilterselector).on("change",function(){window.onbeforeunload=null;var c=a(this).attr("id").substring(6,a(this).attr("id").indexOf("filter")),d=b.rb_init_filter_addbutton(a(this),c),f=a("#id_new"+c+"advanced"),g=a(e.filternametextselector,a(this).parents("tr:first")),h=a(e.customnamecheckselector,a(this).parents("tr:first")),i=a(this).val();0==i?(f.prop("disabled",!0),f.removeAttr("checked"),g.val(""),g.prop("disabled",!0),d.remove(),h.removeAttr("checked"),h.prop("disabled",!0)):(f.prop("disabled",!1),h.prop("disabled",!1))}),b.rb_init_filter_deletebuttons(),b.rb_init_filter_movedown_btns(),b.rb_init_filter_moveup_btns()},rb_init_search_column_rows:function(){var b=this;a(e.searchcolumnselectselector).off("change"),a(e.searchcolumnselectselector).on("change",function(){window.onbeforeunload=null}),a(e.newsearchcolumnselector).on("change",function(){window.onbeforeunload=null;var c=b.rb_init_search_column_addbutton(a(this)),d=a(this).val();0==d&&c.remove()}),b.rb_init_search_column_deletebuttons()},rb_init_filter_addbutton:function(b,c){var d=this,f=a("#id_new"+c+"advanced"),g=a("#id_new"+c+"customname"),h=f.closest("td").next("td"),i=b.closest("td"),j=b.closest("tr").clone();j.find("input:text").val("");var k=h.find(".additembtn");return 0!=k.length?k:(k=d.rb_get_btn_add(d.config.rb_reportid),h.prepend(k),k.off("click"),k.on("click",function(l){l.preventDefault();var m=a("#id_new"+c+"filtername").val();a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"add",sesskey:d.config.user_sesskey,id:d.config.rb_reportid,filter:b.val(),advanced:Number(f.is(":checked")),region:c,customname:Number(g.is(":checked")),filtername:m},beforeSend:function(){k.html(d.loadingimg)},success:function(g){if(g.length>0){var l=parseInt(g),m=d.rb_get_filter_btn_delete(d.config.rb_reportid,l),n="",o=b.closest("tr").prev("tr");if(o.find(e.filterselector).length>0)var n=d.rb_get_filter_btn_up(d.config.rb_reportid,l);k.remove(),h.prepend(m,n),d.config.rb_filters++,a("#id_new"+c+"filter").parents(".fitem").removeClass("new_standard_filter_selector"),a("#id_new"+c+"filter").parents(".fitem").removeClass("new_sidebar_filter_selector"),a("#id_new"+c+"filter").removeClass("new_standard_filter_selector"),a("#id_new"+c+"filter").removeClass("new_sidebar_filter_selector");var p=i,q=a("#id_new"+c+"customname"),r=a("#id_new"+c+"filtername");p.find(e.filterselector).attr("name","filter"+l),p.find("optgroup[label=New]").remove(),p.find(e.filterselector).attr("id","id_filter"+l),q.attr("id","id_customname"+l),q.attr("name","customname"+l),r.attr("id","id_filtername"+l),r.attr("name","filtername"+l),f.attr("name","advanced"+l),f.attr("id","id_advanced"+l),f.closest("tr").attr("fid",l),p.closest("table").append(j),d.rb_reload_filter_option_btns(o);var s=b.val().split("-")[0],t=b.val().split("-")[1];a(".new_standard_filter_selector optgroup option[value="+s+"-"+t+"]").remove(),a(".new_sidebar_filter_selector optgroup option[value="+s+"-"+t+"]").remove(),d.rb_init_filter_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),k)},rb_init_search_column_addbutton:function(b){var c=this,d=b.closest("td").next("td"),f=b.closest("td"),g=b.closest("tr").clone();g.find("input:text").val("");var h=d.find(".additembtn");return 0!=h.length?h:(h=c.rb_get_btn_add(c.config.rb_reportid),d.prepend(h),h.off("click"),h.on("click",function(i){i.preventDefault(),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/searchcolumn.php",type:"POST",data:{action:"add",sesskey:c.config.user_sesskey,id:c.config.rb_reportid,searchcolumn:b.val()},beforeSend:function(){h.html(c.loadingimg)},success:function(i){if(i.length>0){var j=parseInt(i),k=c.rb_get_search_column_btn_delete(c.config.rb_reportid,j);h.remove(),d.prepend(k),c.config.rb_filters++,a("#id_newsearchcolumn").removeClass("new_search_column_selector");var l=f;l.find(e.searchcolumnselectselector).attr("name","searchcolumn"+j),l.find("select optgroup[label=New]").remove(),l.find(e.searchcolumnselectselector).attr("id","id_searchcolumn"+j),f.closest("tr").attr("searchcolumnid",j),l.closest("table").append(g);var m=b.val().split("-")[0],n=b.val().split("-")[1];a(".new_search_column_selector optgroup option[value="+m+"-"+n+"]").remove(),c.rb_init_search_column_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),h)},rb_init_filter_deletebuttons:function(){var b=this;a(".reportbuilderform table .deletefilterbtn").off("click"),a(".reportbuilderform table .deletefilterbtn").on("click",function(f){f.preventDefault();var g=a(this),h=M.util.get_string("confirm","moodle"),i=M.util.get_string("confirmfilterdelete","local_reportbuilder");if(b.config.rb_initial_display&&1==b.config.rb_filters){var j="";1==b.config.rb_global_initial_display&&(j=M.util.get_string("confirmfilterdelete_grid_enabled","local_reportbuilder")),i=M.util.get_string("confirmfilterdelete_rid_enabled","local_reportbuilder",j)}var k=a(this).closest("tr");c.create({title:h,body:i,type:c.types.CONFIRM}).done(function(c){c.getRoot().on(d.yes,function(){b.config.rb_filters--,a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"delete",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,fid:k.attr("fid")},beforeSend:function(){g.replaceWith(b.loadingimg)},success:function(c){if(c.length>0){c=JSON.parse(c);var d=k.prev("tr"),f=k.next("tr");k.remove(),d.find(e.filterselector).length>0&&b.rb_reload_filter_option_btns(d),f.find(e.notnewfilterselector).length>0&&b.rb_reload_filter_option_btns(f);var g=c.typelabel,h=a("#id_all_sidebar_filters").find("option[value="+c.type+"-"+c.value+"]").length>0,i=a(".new_standard_filter_selector optgroup[label='"+g+"']");if(0==i.length&&(i=a('<optgroup label="'+g+'"></optgroup>'),a(".new_standard_filter_selector").append(i)),0==i.find("option[value="+c.type+"-"+c.value+"]").length&&i.append('<option value="'+c.type+"-"+c.value+'">'+rb_filter_headings[c.type+"-"+c.value]+"</option>"),h){var j=a('[name="new_sidebar_filter_selector"] optgroup[label="'+g+'"]');0==j.length&&(j=a('<optgroup label="'+g+'"></optgroup>'),a('[name="new_sidebar_filter_selector"]').append(j)),0==j.find('option[value="'+c.type+"-"+c.value+'"]').length&&j.append('<option value="'+c.type+"-"+c.value+'">'+rb_filter_headings[c.type+"-"+c.value]+"</option>")}b.rb_init_filter_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),c.show(),c.getRoot().on(d.hidden,function(){c.destroy()})})})},rb_init_search_column_deletebuttons:function(){var b=this;a(".reportbuilderform table .deletesearchcolumnbtn").off("click"),a(".reportbuilderform table .deletesearchcolumnbtn").on("click",function(e){e.preventDefault();var f=a(this),g=M.util.get_string("confirm","moodle"),h=M.util.get_string("confirmsearchcolumndelete","local_reportbuilder");if(b.config.rb_initial_display&&1==b.config.rb_filters){var i="";1==b.config.rb_global_initial_display&&(i=M.util.get_string("confirmfilterdelete_grid_enabled","local_reportbuilder")),h=M.util.get_string("confirmfilterdelete_rid_enabled","local_reportbuilder",i)}var j=a(this).closest("tr");c.create({title:g,body:h,type:c.types.CONFIRM}).done(function(c){c.getRoot().on(d.yes,function(){b.config.rb_filters--,a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/searchcolumn.php",type:"POST",data:{action:"delete",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,searchcolumnid:j.attr("searchcolumnid")},beforeSend:function(){f.replaceWith(b.loadingimg)},success:function(c){if(c.length>0){c=JSON.parse(c),j.remove();var d=c.typelabel,e=a(".new_search_column_selector optgroup[label='"+d+"']");0==e.length&&(e=a('<optgroup label="'+d+'"></optgroup>'),a(".new_search_column_selector").append(e)),0==e.find("option[value="+c.type+"-"+c.value+"]").length&&e.append('<option value="'+c.type+"-"+c.value+'">'+rb_search_column_headings[c.type+"-"+c.value]+"</option>"),b.rb_init_search_column_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),c.show(),c.getRoot().on(d.hidden,function(){c.destroy()})})})},rb_init_filter_movedown_btns:function(){var b=this;a(".reportbuilderform table .movefilterdownbtn").off("click"),a(".reportbuilderform table .movefilterdownbtn").on("click",function(c){c.preventDefault();var d=a(this).closest("tr"),f=d.clone();f.find(e.filterselector).find("option[value="+d.find(e.filterselector).val()+"]").attr("selected","selected");var g=d.next("tr"),h=g.clone();h.find(e.filterselector).find("option[value="+g.find(e.filterselector).val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"movedown",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,fid:d.attr("fid")},beforeSend:function(){g.html(b.loadingimg),d.html(b.loadingimg),f.find("td *").hide(),h.find("td *").hide()},success:function(a){a.length>0?(d.replaceWith(h),g.replaceWith(f),f.find("td *").fadeIn(),h.find("td *").fadeIn(),b.rb_reload_filter_option_btns(f),b.rb_reload_filter_option_btns(h),b.rb_init_filter_rows()):alert("Error")},error:function(a,b,c){alert("Error")}})})},rb_init_filter_moveup_btns:function(){var b=this;a(".reportbuilderform table .movefilterupbtn").off("click"),a(".reportbuilderform table .movefilterupbtn").on("click",function(c){c.preventDefault();var d=(a(this),a(this).closest("tr")),f=d.clone();f.find(e.filterselector).find("option[value="+d.find(e.filterselector).val()+"]").attr("selected","selected");var g=d.prev("tr"),h=g.clone();h.find(e.filterselector).find("option[value="+g.find(e.filterselector).val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"moveup",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,fid:d.attr("fid")},beforeSend:function(){g.html(b.loadingimg),d.html(b.loadingimg),f.find("td *").hide(),h.find("td *").hide()},success:function(a){a.length>0?(d.replaceWith(h),g.replaceWith(f),f.find("td *").fadeIn(),h.find("td *").fadeIn(),b.rb_reload_filter_option_btns(f),b.rb_reload_filter_option_btns(h),b.rb_init_filter_rows()):alert("Error")},error:function(a,b,c){alert("Error")}})})},rb_reload_filter_option_btns:function(a){var b=this,c=a.children("td").filter(":last");c.empty();var d=a.attr("fid"),f=b.rb_get_filter_btn_delete(b.config.rb_reportid,d),g=this.spacer;a.prev("tr").find(e.filterselector).length>0&&(g=b.rb_get_filter_btn_up(b.config.rb_reportid,d));var h=this.spacer;a.next("tr").next("tr").find(e.filterselector).length>0&&(h=b.rb_get_filter_btn_down(b.config.rb_reportid,d)),c.append(f,g,h)},rb_reload_search_column_option_btns:function(a){var b=this,c=a.children("td").filter(":last");c.empty();var d=a.attr("searchcolumnid"),e=b.rb_get_search_column_btn_delete(b.config.rb_reportid,d);c.append(e)},rb_get_filter_btn_delete:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&fid="+c+'&d=1" class="deletefilterbtn action-icon">'+this.deleteicon+"</a>")},rb_get_search_column_btn_delete:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&searchcolumnid="+c+'&d=1" class="deletesearchcolumnbtn action-icon">'+this.deleteicon+"</a>")},rb_get_filter_btn_up:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&fid="+c+'&m=up" class="movefilterupbtn action-icon">'+this.upicon+"</a>")},rb_get_filter_btn_down:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&fid="+c+'&m=down" class="movefilterdownbtn action-icon">'+this.downicon+"</a>")},rb_get_btn_add:function(b){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+'" class="additembtn"><input class="btn btn-secondary" type="button" value="'+M.util.get_string("add","local_reportbuilder")+'" /></a>')}};return e});