define(["jquery","core/templates","core/modal_factory","core/modal_events"],function(a,b,c,d){var e={config:{},loadingimg:"",deleteicon:"",upicon:"",downicon:"",spacer:"",init:function(c){if(c){var d=a.parseJSON(c);for(var e in d)this.config[e]=d[e]}var f=this,g=[];g.push(b.renderPix("i/loading","core",M.util.get_string("saving","local_reportbuilder"))),g.push(b.renderPix("t/delete","core",M.util.get_string("delete","local_reportbuilder"))),g.push(b.renderPix("t/up","core",M.util.get_string("moveup","local_reportbuilder"))),g.push(b.renderPix("t/down","core",M.util.get_string("movedown","local_reportbuilder"))),g.push(b.renderPix("spacer","")),a.when.apply(a,g).then(function(a,b,c,d,e){f.loadingimg=a,f.deleteicon=b,f.upicon=c,f.downicon=d,f.spacer=e,f.rb_init_filter_rows(),f.rb_init_search_column_rows()})},rb_init_filter_rows:function(){var b=this;a("#id_newstandardcustomname").prop("disabled",!0),a("#id_newsidebarcustomname").prop("disabled",!0),a("div.filter_custom_name_checkbox input").not(":checked").each(function(){var b=a("div.filter_name_text input",a(this).parents("tr:first"));b.prop("disabled",!0)}),a("input.filter_advanced_checkbox").off("click"),a("input.filter_advanced_checkbox").on("click",function(){window.onbeforeunload=null}),a("div.filter_selector select").off("change"),a("div.filter_selector select").on("change",function(){window.onbeforeunload=null;var c=a(this).val(),d=b.config.rb_filter_headings[c],e=a("div.filter_name_text input",a(this).parents("tr:first"));e.val(d)}),a("div.filter_custom_name_checkbox input").off("click"),a("div.filter_custom_name_checkbox input").on("click",function(){window.onbeforeunload=null;var c=a("div.filter_name_text input",a(this).parents("tr:first"));if(a(this).is(":checked"))c.prop("disabled",!1);else{c.prop("disabled",!0);var d=a("div.filter_selector select",a(this).parents("tr:first")).val(),e=b.config.rb_filter_headings[d];c.val(e)}}),a("div.new_standard_filter_selector select, div.new_sidebar_filter_selector select").on("change",function(){window.onbeforeunload=null;var c=a(this).attr("id").substring(6,a(this).attr("id").indexOf("filter")),d=b.rb_init_filter_addbutton(a(this),c),e=a("#id_new"+c+"advanced"),f=a("div.filter_name_text input",a(this).parents("tr:first")),g=a("div.filter_custom_name_checkbox input",a(this).parents("tr:first")),h=a(this).val();0==h?(e.prop("disabled",!0),e.removeAttr("checked"),f.val(""),f.prop("disabled",!0),d.remove(),g.removeAttr("checked"),g.prop("disabled",!0)):(e.prop("disabled",!1),g.prop("disabled",!1))}),b.rb_init_filter_deletebuttons(),b.rb_init_filter_movedown_btns(),b.rb_init_filter_moveup_btns()},rb_init_search_column_rows:function(){var b=this;a("div.search_column_selector select").off("change"),a("div.search_column_selector select").on("change",function(){window.onbeforeunload=null}),a("div.new_search_column_selector select").on("change",function(){window.onbeforeunload=null;var c=b.rb_init_search_column_addbutton(a(this)),d=a(this).val();0==d&&c.remove()}),b.rb_init_search_column_deletebuttons()},rb_init_filter_addbutton:function(b,c){var d=this,e=a("#id_new"+c+"advanced"),f=a("#id_new"+c+"customname"),g=e.closest("td").next("td"),h=b.closest("td"),i=b.closest("tr").clone();i.find("input:text").val("");var j=g.find(".additembtn");return 0!=j.length?j:(j=d.rb_get_btn_add(d.config.rb_reportid),g.prepend(j),j.off("click"),j.on("click",function(k){k.preventDefault();var l=a("#id_new"+c+"filtername").val();a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"add",sesskey:d.config.user_sesskey,id:d.config.rb_reportid,filter:b.val(),advanced:Number(e.is(":checked")),region:c,customname:Number(f.is(":checked")),filtername:l},beforeSend:function(){j.html(d.loadingimg)},success:function(f){if(f.length>0){var k=parseInt(f),l=d.rb_get_filter_btn_delete(d.config.rb_reportid,k),m="",n=b.closest("tr").prev("tr");if(n.find("div.filter_selector select").length>0)var m=d.rb_get_filter_btn_up(d.config.rb_reportid,k);j.remove(),g.prepend(l,m),d.config.rb_filters++,a("#id_new"+c+"filter").parents(".fitem").removeClass("new_standard_filter_selector"),a("#id_new"+c+"filter").parents(".fitem").removeClass("new_sidebar_filter_selector");var o=h,p=a("#id_new"+c+"customname"),q=a("#id_new"+c+"filtername");o.find("div.filter_selector select").attr("name","filter"+k),o.find("select optgroup[label=New]").remove(),o.find("div.filter_selector select").attr("id","id_filter"+k),p.attr("id","id_customname"+k),p.attr("name","customname"+k),q.attr("id","id_filtername"+k),q.attr("name","filtername"+k),e.attr("name","advanced"+k),e.attr("id","id_advanced"+k),e.closest("tr").attr("fid",k),o.closest("table").append(i),d.rb_reload_filter_option_btns(n);var r=b.val().split("-")[0],s=b.val().split("-")[1];a(".new_standard_filter_selector optgroup option[value="+r+"-"+s+"]").remove(),a(".new_sidebar_filter_selector optgroup option[value="+r+"-"+s+"]").remove(),d.rb_init_filter_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),j)},rb_init_search_column_addbutton:function(b){var c=this,d=b.closest("td").next("td"),e=b.closest("td"),f=b.closest("tr").clone();f.find("input:text").val("");var g=d.find(".additembtn");return 0!=g.length?g:(g=c.rb_get_btn_add(c.config.rb_reportid),d.prepend(g),g.off("click"),g.on("click",function(h){h.preventDefault(),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/searchcolumn.php",type:"POST",data:{action:"add",sesskey:c.config.user_sesskey,id:c.config.rb_reportid,searchcolumn:b.val()},beforeSend:function(){g.html(c.loadingimg)},success:function(h){if(h.length>0){var i=parseInt(h),j=c.rb_get_search_column_btn_delete(c.config.rb_reportid,i);g.remove(),d.prepend(j),c.config.rb_filters++,a("#id_newsearchcolumn").removeClass("new_search_column_selector");var k=e;k.find("div.search_column_selector select").attr("name","searchcolumn"+i),k.find("select optgroup[label=New]").remove(),k.find("div.search_column_selector select").attr("id","id_searchcolumn"+i),e.closest("tr").attr("searchcolumnid",i),k.closest("table").append(f);var l=b.val().split("-")[0],m=b.val().split("-")[1];a(".new_search_column_selector optgroup option[value="+l+"-"+m+"]").remove(),c.rb_init_search_column_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),g)},rb_init_filter_deletebuttons:function(){var b=this;a(".reportbuilderform table .deletefilterbtn").off("click"),a(".reportbuilderform table .deletefilterbtn").on("click",function(e){e.preventDefault();var f=a(this),g=M.util.get_string("confirm","moodle"),h=M.util.get_string("confirmfilterdelete","local_reportbuilder");if(b.config.rb_initial_display&&1==b.config.rb_filters){var i="";1==b.config.rb_global_initial_display&&(i=M.util.get_string("confirmfilterdelete_grid_enabled","local_reportbuilder")),h=M.util.get_string("confirmfilterdelete_rid_enabled","local_reportbuilder",i)}var j=a(this).closest("tr");c.create({title:g,body:h,type:c.types.CONFIRM}).done(function(c){c.getRoot().on(d.yes,function(){b.config.rb_filters--,a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"delete",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,fid:j.attr("fid")},beforeSend:function(){f.replaceWith(b.loadingimg)},success:function(c){if(c.length>0){c=JSON.parse(c);var d=j.prev("tr"),e=j.next("tr");j.remove(),d.find("div.filter_selector select").length>0&&b.rb_reload_filter_option_btns(d),e.find('div.filter_selector select:not(.new_standard_filter_selector, [name="new_standard_filter_selector"])').length>0&&b.rb_reload_filter_option_btns(e);var f=c.typelabel,g=a("#id_all_sidebar_filters").find("option[value="+c.type+"-"+c.value+"]").length>0,h=a(".new_standard_filter_selector optgroup[label='"+f+"']");if(0==h.length&&(h=a('<optgroup label="'+f+'"></optgroup>'),a(".new_standard_filter_selector").append(h)),0==h.find("option[value="+c.type+"-"+c.value+"]").length&&h.append('<option value="'+c.type+"-"+c.value+'">'+rb_filter_headings[c.type+"-"+c.value]+"</option>"),g){var i=a('[name="new_sidebar_filter_selector"] optgroup[label="'+f+'"]');0==i.length&&(i=a('<optgroup label="'+f+'"></optgroup>'),a('[name="new_sidebar_filter_selector"]').append(i)),0==i.find('option[value="'+c.type+"-"+c.value+'"]').length&&i.append('<option value="'+c.type+"-"+c.value+'">'+rb_filter_headings[c.type+"-"+c.value]+"</option>")}b.rb_init_filter_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),c.show(),c.getRoot().on(d.hidden,function(){c.destroy()})})})},rb_init_search_column_deletebuttons:function(){var b=this;a(".reportbuilderform table .deletesearchcolumnbtn").off("click"),a(".reportbuilderform table .deletesearchcolumnbtn").on("click",function(e){e.preventDefault();var f=a(this),g=M.util.get_string("confirm","moodle"),h=M.util.get_string("confirmsearchcolumndelete","local_reportbuilder");if(b.config.rb_initial_display&&1==b.config.rb_filters){var i="";1==b.config.rb_global_initial_display&&(i=M.util.get_string("confirmfilterdelete_grid_enabled","local_reportbuilder")),h=M.util.get_string("confirmfilterdelete_rid_enabled","local_reportbuilder",i)}var j=a(this).closest("tr");c.create({title:g,body:h,type:c.types.CONFIRM}).done(function(c){c.getRoot().on(d.yes,function(){b.config.rb_filters--,a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/searchcolumn.php",type:"POST",data:{action:"delete",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,searchcolumnid:j.attr("searchcolumnid")},beforeSend:function(){f.replaceWith(b.loadingimg)},success:function(c){if(c.length>0){c=JSON.parse(c),j.remove();var d=c.typelabel,e=a(".new_search_column_selector optgroup[label='"+d+"']");0==e.length&&(e=a('<optgroup label="'+d+'"></optgroup>'),a(".new_search_column_selector").append(e)),0==e.find("option[value="+c.type+"-"+c.value+"]").length&&e.append('<option value="'+c.type+"-"+c.value+'">'+rb_search_column_headings[c.type+"-"+c.value]+"</option>"),b.rb_init_search_column_rows()}else alert("Error")},error:function(a,b,c){alert("Error")}})}),c.show(),c.getRoot().on(d.hidden,function(){c.destroy()})})})},rb_init_filter_movedown_btns:function(){var b=this;a(".reportbuilderform table .movefilterdownbtn").off("click"),a(".reportbuilderform table .movefilterdownbtn").on("click",function(c){c.preventDefault();var d=a(this).closest("tr"),e=d.clone();e.find("div.filter_selector select option[value="+d.find("div.filter_selector select").val()+"]").attr("selected","selected");var f=d.next("tr"),g=f.clone();g.find("div.filter_selector select option[value="+f.find("div.filter_selector select").val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"movedown",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,fid:d.attr("fid")},beforeSend:function(){f.html(b.loadingimg),d.html(b.loadingimg),e.find("td *").hide(),g.find("td *").hide()},success:function(a){a.length>0?(d.replaceWith(g),f.replaceWith(e),e.find("td *").fadeIn(),g.find("td *").fadeIn(),b.rb_reload_filter_option_btns(e),b.rb_reload_filter_option_btns(g),b.rb_init_filter_rows()):alert("Error")},error:function(a,b,c){alert("Error")}})})},rb_init_filter_moveup_btns:function(){var b=this;a(".reportbuilderform table .movefilterupbtn").off("click"),a(".reportbuilderform table .movefilterupbtn").on("click",function(c){c.preventDefault();var d=(a(this),a(this).closest("tr")),e=d.clone();e.find("div.filter_selector select option[value="+d.find("div.filter_selector select").val()+"]").attr("selected","selected");var f=d.prev("tr"),g=f.clone();g.find("div.filter_selector select option[value="+f.find("div.filter_selector select").val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/filter.php",type:"POST",data:{action:"moveup",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,fid:d.attr("fid")},beforeSend:function(){f.html(b.loadingimg),d.html(b.loadingimg),e.find("td *").hide(),g.find("td *").hide()},success:function(a){a.length>0?(d.replaceWith(g),f.replaceWith(e),e.find("td *").fadeIn(),g.find("td *").fadeIn(),b.rb_reload_filter_option_btns(e),b.rb_reload_filter_option_btns(g),b.rb_init_filter_rows()):alert("Error")},error:function(a,b,c){alert("Error")}})})},rb_reload_filter_option_btns:function(a){var b=this,c=a.children("td").filter(":last");c.empty();var d=a.attr("fid"),e=b.rb_get_filter_btn_delete(b.config.rb_reportid,d),f=this.spacer;a.prev("tr").find("div.filter_selector select").length>0&&(f=b.rb_get_filter_btn_up(b.config.rb_reportid,d));var g=this.spacer;a.next("tr").next("tr").find("div.filter_selector select").length>0&&(g=b.rb_get_filter_btn_down(b.config.rb_reportid,d)),c.append(e,f,g)},rb_reload_search_column_option_btns:function(a){var b=this,c=a.children("td").filter(":last");c.empty();var d=a.attr("searchcolumnid"),e=b.rb_get_search_column_btn_delete(b.config.rb_reportid,d);c.append(e)},rb_get_filter_btn_delete:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&fid="+c+'&d=1" class="deletefilterbtn action-icon">'+this.deleteicon+"</a>")},rb_get_search_column_btn_delete:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&searchcolumnid="+c+'&d=1" class="deletesearchcolumnbtn action-icon">'+this.deleteicon+"</a>")},rb_get_filter_btn_up:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&fid="+c+'&m=up" class="movefilterupbtn action-icon">'+this.upicon+"</a>")},rb_get_filter_btn_down:function(b,c){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+"&fid="+c+'&m=down" class="movefilterdownbtn action-icon">'+this.downicon+"</a>")},rb_get_btn_add:function(b){return a("<a href="+M.cfg.wwwroot+"/local/reportbuilder/filters.php?id="+b+'" class="additembtn"><input class="btn btn-secondary" type="button" value="'+M.util.get_string("add","local_reportbuilder")+'" /></a>')}};return e});