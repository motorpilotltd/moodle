define(["jquery","core/templates","core/modal_factory","core/modal_events"],function(a,b,c,d){var e={config:{},loadingimg:"",advoptionshtml:"",hideicon:"",showicon:"",deleteicon:"",upicon:"",downicon:"",spacer:"",init:function(c){if(this.config=c,this.config.user_sesskey=M.cfg.sesskey,"undefined"==typeof a)throw new Error("M.local_reportbuildercolumns.init()-> jQuery dependency required for this module to function.");this.advoptionshtml=a("select.new_advanced_selector").html();var d=this,e=[];e.push(b.renderPix("i/loading","core",M.util.get_string("saving","local_reportbuilder"))),e.push(b.renderPix("i/hide","core",M.util.get_string("hide","local_reportbuilder"))),e.push(b.renderPix("i/show","core",M.util.get_string("show","local_reportbuilder"))),e.push(b.renderPix("t/delete","core",M.util.get_string("delete","local_reportbuilder"))),e.push(b.renderPix("t/up","core",M.util.get_string("moveup","local_reportbuilder"))),e.push(b.renderPix("t/down","core",M.util.get_string("movedown","local_reportbuilder"))),e.push(b.renderPix("spacer","")),a.when.apply(a,e).then(function(a,b,c,e,f,g,h){d.loadingimg=a,d.hideicon=b,d.showicon=c,d.deleteicon=e,d.upicon=f,d.downicon=g,d.spacer=h,d.rb_init_col_rows()})},rb_update_col_row:function(b){var c=this,d=a(b).val(),e=c.config.rb_column_headings[d],f=a("div.advanced_selector select",a(b).parents("tr:first")),g=a("div.column_heading_text input",a(b).parents("tr:first")),h=a("div.column_custom_heading_checkbox input",a(b).parents("tr:first"));if("0"==d)f.hide(),h.hide(),g.hide();else if(a.inArray(d,c.config.rb_grouped_columns)==-1){f.show(),h.show(),g.show();var i=f.val();if(""!=i)if(a.inArray(i,c.config.rb_allowed_advanced[d])==-1)f.val(""),i="";else{var j=i.replace("transform_","transformtype").replace("aggregate_","aggregatetype")+"_heading";e=M.util.get_string(j,"local_reportbuilder",e)}f.html(c.advoptionshtml),f.val(i),f.find("option").each(function(){var b=a(this);a.inArray(b.val(),c.config.rb_allowed_advanced[d])==-1&&b.remove()}),f.children().each(function(){var b=a(this);0==b.children().length&&b.remove()})}else f.hide(),h.show(),g.show(),f.val("");h.is(":checked")?g.prop("disabled",!1):(g.prop("disabled",!0),g.val(e))},rb_init_col_rows:function(){var b=this;a("#id_newheading").prop("disabled",!0),a("#id_newcustomheading").prop("disabled",!0),a("div.column_selector select").off("change"),a("div.column_selector select").on("change",function(){window.onbeforeunload=null,b.rb_update_col_row(this)}),a("div.advanced_selector select").off("change"),a("div.advanced_selector select").on("change",function(){window.onbeforeunload=null;var c=a("div.column_selector select",a(this).parents("tr:first"));b.rb_update_col_row(c)}),a("div.column_custom_heading_checkbox input").off("click"),a("div.column_custom_heading_checkbox input").on("click",function(){window.onbeforeunload=null;var c=a("div.column_selector select",a(this).parents("tr:first"));b.rb_update_col_row(c)}),a("div.new_column_selector select").on("change",function(){window.onbeforeunload=null;var c=a("div.column_heading_text input",a(this).parents("tr:first")),d=a("div.column_custom_heading_checkbox input",a(this).parents("tr:first")),e=b.rb_init_addbutton(a(this));0==a(this).val()?(c.val(""),c.prop("disabled",!0),e.remove(),d.removeAttr("checked"),d.prop("disabled",!0)):d.prop("disabled",!1)}),a("div.column_selector select").each(function(){b.rb_update_col_row(this)}),this.rb_init_deletebuttons(),this.rb_init_hidebuttons(),this.rb_init_showbuttons(),this.rb_init_movedown_btns(),this.rb_init_moveup_btns()},rb_init_addbutton:function(b){var c=this,d=a("div.advanced_selector select",b.parents("tr:first")),e=a("div.column_custom_heading_checkbox input",b.parents("tr:first")),f=a("div.column_heading_text input",b.parents("tr:first")),g=a("td:last",f.parents("tr:first")),h=b.closest("tr").clone(),i=g.find(".addcolbtn");return 0!=i.length?i:(i=this.rb_get_btn_add(c.config.rb_reportid),g.prepend(i),i.off("click"),i.on("click",function(j){var k={action:"add",sesskey:c.config.user_sesskey,id:c.config.rb_reportid,col:b.val(),heading:f.val(),advanced:d.val(),customheading:e.is(":checked")?1:0},l=i.html();j.preventDefault(),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:k,beforeSend:function(){i.html(c.loadingimg)},success:function(e){if(0==e.length)alert(M.util.get_string("error","moodle")),location.reload();else if(e.error){if(alert(e.error),e.noreload)return void i.html(l);location.reload()}else{var j=parseInt(e.result),k=c.rb_get_btn_hide(c.config.rb_reportid,j),m=c.rb_get_btn_delete(c.config.rb_reportid,j),n="",o=b.closest("tr").prev("tr");if(o.find("div.column_selector select").length>0)var n=c.rb_get_btn_up(c.config.rb_reportid,j);i.remove(),g.prepend(k,m,n);var p=a("td:first",g.parents("tr:first")),q=a("div.column_selector select",p),r=a("div.column_custom_heading_checkbox input",g.parents("tr:first"));q.parents(".fitem").removeClass("new_column_selector"),q.attr("name","column"+j),q.attr("id","id_column"+j),p.find("select optgroup[label=New]").remove(),d.removeClass("new_advanced_selector"),d.attr("name","advanced"+j),d.attr("id","id_advanced"+j),r.attr("name","customheading"+j),r.removeAttr("id"),f.attr("name","heading"+j),f.attr("id","id_heading"+j),f.closest("tr").attr("colid",j),h.find("input[name=newheading]").val(""),p.closest("table").append(h),c.rb_reload_option_btns(o);var s=b.val().split("-")[0],t=b.val().split("-")[1];a(".new_column_selector optgroup option[value="+s+"-"+t+"]").remove(),a("select[name=defaultsortcolumn]").append('<option value="'+s+"_"+t+'">'+c.config.rb_column_headings[s+"-"+t]+"</option>"),c.rb_init_col_rows()}},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})}),i)},rb_init_deletebuttons:function(){function b(a){return(a+"").replace(/^([a-z])|\s+([a-z])/g,function(a){return a.toUpperCase()})}var e=this;a(".reportbuilderform table .deletecolbtn").off("click"),a(".reportbuilderform table .deletecolbtn").on("click",function(f){f.preventDefault();var g=a(this),h=M.util.get_string("confirm","moodle"),i=a(this).closest("tr"),j=M.util.get_string("confirmcoldelete","local_reportbuilder");c.create({title:h,body:j,type:c.types.CONFIRM}).done(function(c){c.getRoot().on(d.yes,function(){a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"delete",sesskey:e.config.user_sesskey,id:e.config.rb_reportid,cid:i.attr("colid")},beforeSend:function(){g.replaceWith(e.loadingimg)},success:function(c){if(c.success){var d=i.prev("tr"),f=i.next("tr");i.remove();var g=c.result;d.find("div.column_selector select").length>0&&e.rb_reload_option_btns(d),f.find("div.column_selector select:not(.new_column_selector)").length>0&&e.rb_reload_option_btns(f);var h=b(g.optgroup_label),j=a(".new_column_selector optgroup[label='"+h+"']");0==j.length&&(j=a('<optgroup label="'+h+'"></optgroup>'),a(".new_column_selector").append(j)),0==j.find("option[value="+g.type+"-"+g.value+"]").length&&j.append('<option value="'+g.type+"-"+g.value+'">'+e.config.rb_column_headings[g.type+"-"+g.value]+"</option>"),a("select[name=defaultsortcolumn] option[value="+g.type+"_"+g.value+"]").remove(),e.rb_init_col_rows()}else"undefined"==typeof c.noalert&&alert(M.util.get_string("error","moodle")),location.reload()},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})}),c.show(),c.getRoot().on(d.hidden,function(){c.destroy()})})})},rb_init_hidebuttons:function(){var b=this;a(".reportbuilderform table .hidecolbtn").off("click"),a(".reportbuilderform table .hidecolbtn").on("click",function(c){c.preventDefault();var d=a(this),e=a(this).closest("tr");a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"hide",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:e.attr("colid")},beforeSend:function(){d.find("img").replaceWith(b.loadingimg)},success:function(a){if(a.success){var c=e.attr("colid"),f=b.rb_get_btn_show(b.config.rb_reportid,c);d.replaceWith(f),b.rb_init_col_rows()}else alert(M.util.get_string("error","moodle")),location.reload()},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_init_showbuttons:function(){var b=this;a(".reportbuilderform table .showcolbtn").off("click"),a(".reportbuilderform table .showcolbtn").on("click",function(c){c.preventDefault();var d=a(this),e=a(this).closest("tr");a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"show",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:e.attr("colid")},beforeSend:function(){d.find("img").replaceWith(b.loadingimg)},success:function(a){if(a.success){var c=e.attr("colid"),f=b.rb_get_btn_hide(b.config.rb_reportid,c);d.replaceWith(f),b.rb_init_col_rows()}else alert(M.util.get_string("error","moodle")),location.reload()},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_init_movedown_btns:function(){var b=this;a(".reportbuilderform table .movecoldownbtn").off("click"),a(".reportbuilderform table .movecoldownbtn").on("click",function(c){c.preventDefault();var d=(a(this),a(this).closest("tr")),e=d.clone();""!==d.find("div.column_selector select").val()&&e.find("div.column_selector select option[value="+d.find("div.column_selector select").val()+"]").attr("selected","selected"),""!==d.find("div.advanced_selector select").val()&&e.find("div.advanced_selector select option[value="+d.find("div.advanced_selector select").val()+"]").attr("selected","selected");var f=d.next("tr"),g=f.clone();""!==f.find("div.column_selector select").val()&&g.find("div.column_selector select option[value="+f.find("div.column_selector select").val()+"]").attr("selected","selected"),""!==f.find("div.advanced_selector select").val()&&g.find("div.advanced_selector select option[value="+f.find("div.advanced_selector select").val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"movedown",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:d.attr("colid")},beforeSend:function(){f.html(b.loadingimg),d.html(b.loadingimg),e.find("td *").hide(),g.find("td *").hide()},success:function(a){a.success?(d.replaceWith(g),f.replaceWith(e),e.find("td *").fadeIn(),g.find("td *").fadeIn(),b.rb_reload_option_btns(e),b.rb_reload_option_btns(g),b.rb_init_col_rows()):(alert(M.util.get_string("error","moodle")),location.reload())},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_init_moveup_btns:function(){var b=this;a(".reportbuilderform table .movecolupbtn").off("click"),a(".reportbuilderform table .movecolupbtn").on("click",function(c){c.preventDefault();var d=(a(this),a(this).closest("tr")),e=d.clone();""!==d.find("div.column_selector select").val()&&e.find("div.column_selector select option[value="+d.find("div.column_selector select").val()+"]").attr("selected","selected"),""!==d.find("div.advanced_selector select").val()&&e.find("div.advanced_selector select option[value="+d.find("div.advanced_selector select").val()+"]").attr("selected","selected");var f=d.prev("tr"),g=f.clone();""!==f.find("div.column_selector select").val()&&g.find("div.column_selector select option[value="+f.find("div.column_selector select").val()+"]").attr("selected","selected"),""!==f.find("div.advanced_selector select").val()&&g.find("div.advanced_selector select option[value="+f.find("div.advanced_selector select").val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"moveup",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:d.attr("colid")},beforeSend:function(){f.html(b.loadingimg),d.html(b.loadingimg),e.find("td *").hide(),g.find("td *").hide()},success:function(a){a.success?(d.replaceWith(g),f.replaceWith(e),e.find("td *").fadeIn(),g.find("td *").fadeIn(),b.rb_reload_option_btns(e),b.rb_reload_option_btns(g),b.rb_init_col_rows()):(alert(M.util.get_string("error","moodle")),location.reload())},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_reload_option_btns:function(a){var b=a.children("td").filter(":last"),c=b.find(".hidecolbtn");0==c.length&&(c=b.find(".showcolbtn")),c=c.closest("a"),b.empty();var d=a.attr("colid"),e=this.rb_get_btn_delete(this.config.rb_reportid,d),f=this.spacer;a.prev("tr").find("div.column_selector select").length>0&&(f=this.rb_get_btn_up(this.config.rb_reportid,d));var g=this.spacer;a.next("tr").next("tr").find("div.column_selector select").length>0&&(g=this.rb_get_btn_down(this.config.rb_reportid,d)),b.append(c,e,f,g)},rb_get_btn_hide:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&h=1" title="'+M.util.get_string("hide","local_reportbuilder")+'" class="hidecolbtn action-icon">'+this.hideicon+"</a>")},rb_get_btn_show:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&h=0" title="'+M.util.get_string("show","local_reportbuilder")+'" class="showcolbtn action-icon">'+this.showicon+"</a>")},rb_get_btn_delete:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&d=1" title="'+M.util.get_string("delete","local_reportbuilder")+'" class="deletecolbtn action-icon">'+this.deleteicon+"</a>")},rb_get_btn_up:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&m=up" title="'+M.util.get_string("moveup","local_reportbuilder")+'" class="movecolupbtn action-icon">'+this.upicon+"</a>")},rb_get_btn_down:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&m=down" title="'+M.util.get_string("movedown","local_reportbuilder")+'" class="movecoldownbtn action-icon">'+this.downicon+"</a>")},rb_get_btn_add:function(b){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+'" class="addcolbtn"><input class="btn btn-secondary" type="button" value="'+M.util.get_string("add","local_reportbuilder")+'" /></a>')}};return e});