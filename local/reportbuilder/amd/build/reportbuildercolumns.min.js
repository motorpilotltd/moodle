define(["jquery","core/templates","core/modal_factory","core/modal_events","core/ajax","core/notification"],function(a,b,c,d,e,f){var g={config:{},loadingimg:"",advoptionshtml:"",hideicon:"",showicon:"",deleteicon:"",upicon:"",downicon:"",spacer:"",columnselector:"div.column_selector select, select.column_selector",advancedselector:"div.advanced_selector select, select.advanced_selector",headingtextselector:"div.column_heading_text input, input.column_heading_text",customheadingcheckselector:"div.column_custom_heading_checkbox input, input.column_custom_heading_checkbox",columnselectornotnew:"div.column_selector select:not(.new_column_selector), select.column_selector:not(.new_column_selector)",init:function(c){var d={id:c.rb_reportid},g={methodname:"local_reportbuilder_report_columns_config",args:d},h=e.call([g])[0];if(h.fail(f.exception),"undefined"==typeof a)throw new Error("M.local_reportbuildercolumns.init()-> jQuery dependency required for this module to function.");this.advoptionshtml=a("select.new_advanced_selector").html();var i=this,j=[];j.push(b.renderPix("i/loading","core",M.util.get_string("saving","local_reportbuilder"))),j.push(b.renderPix("i/hide","core",M.util.get_string("hide","local_reportbuilder"))),j.push(b.renderPix("i/show","core",M.util.get_string("show","local_reportbuilder"))),j.push(b.renderPix("t/delete","core",M.util.get_string("delete","local_reportbuilder"))),j.push(b.renderPix("t/up","core",M.util.get_string("moveup","local_reportbuilder"))),j.push(b.renderPix("t/down","core",M.util.get_string("movedown","local_reportbuilder"))),j.push(b.renderPix("spacer","")),j.push(h),a.when.apply(a,j).then(function(a,b,c,d,e,f,g,h){i.loadingimg=a,i.hideicon=b,i.showicon=c,i.deleteicon=d,i.upicon=e,i.downicon=f,i.spacer=g;var j=JSON.parse(h.config);i.config=j,i.config.user_sesskey=M.cfg.sesskey,i.rb_init_col_rows()})},rb_update_col_row:function(b){var c=this,d=a(b).val(),e=c.config.rb_column_headings[d],f=a(g.advancedselector,a(b).parents("tr:first")),h=a(g.headingtextselector,a(b).parents("tr:first")),i=a(g.customheadingcheckselector,a(b).parents("tr:first"));if("0"==d)f.hide(),i.hide(),h.hide();else if(a.inArray(d,c.config.rb_grouped_columns)==-1){f.show(),i.show(),h.show();var j=f.val();if(""!=j)if(a.inArray(j,c.config.rb_allowed_advanced[d])==-1)f.val(""),j="";else{var k=j.replace("transform_","transformtype").replace("aggregate_","aggregatetype")+"_heading";e=M.util.get_string(k,"local_reportbuilder",e)}f.html(c.advoptionshtml),f.val(j),f.find("option").each(function(){var b=a(this);a.inArray(b.val(),c.config.rb_allowed_advanced[d])==-1&&b.remove()}),f.children().each(function(){var b=a(this);0==b.children().length&&b.remove()})}else f.hide(),i.show(),h.show(),f.val("");i.is(":checked")?h.prop("disabled",!1):(h.prop("disabled",!0),h.val(e))},rb_init_col_rows:function(){var b=this;a("#id_newheading").prop("disabled",!0),a("#id_newcustomheading").prop("disabled",!0),a(g.columnselector).off("change"),a(g.columnselector).on("change",function(){window.onbeforeunload=null,b.rb_update_col_row(this)}),a(g.advancedselector).off("change"),a(g.advancedselector).on("change",function(){window.onbeforeunload=null;var c=a(g.columnselector,a(this).parents("tr:first"));b.rb_update_col_row(c)}),a(g.customheadingcheckselector).off("click"),a("div.column_custom_heading_checkbox input,  input.column_custom_heading_checkbox").on("click",function(){window.onbeforeunload=null;var c=a(g.columnselector,a(this).parents("tr:first"));b.rb_update_col_row(c)}),a("div.new_column_selector select, select.new_column_selector").on("change",function(){window.onbeforeunload=null;var c=a(g.headingtextselector,a(this).parents("tr:first")),d=a(g.customheadingcheckselector,a(this).parents("tr:first")),e=b.rb_init_addbutton(a(this));0==a(this).val()?(c.val(""),c.prop("disabled",!0),e.remove(),d.removeAttr("checked"),d.prop("disabled",!0)):d.prop("disabled",!1)}),a(g.columnselector).each(function(){b.rb_update_col_row(this)}),this.rb_init_deletebuttons(),this.rb_init_hidebuttons(),this.rb_init_showbuttons(),this.rb_init_movedown_btns(),this.rb_init_moveup_btns()},rb_init_addbutton:function(b){var c=this,d=a(g.advancedselector,b.parents("tr:first")),e=a(g.customheadingcheckselector,b.parents("tr:first")),f=a(g.headingtextselector,b.parents("tr:first")),h=a("td:last",f.parents("tr:first")),i=b.closest("tr").clone(),j=h.find(".addcolbtn");return 0!=j.length?j:(j=this.rb_get_btn_add(c.config.rb_reportid),h.prepend(j),j.off("click"),j.on("click",function(k){var l={action:"add",sesskey:c.config.user_sesskey,id:c.config.rb_reportid,col:b.val(),heading:f.val(),advanced:d.val(),customheading:e.is(":checked")?1:0},m=j.html();k.preventDefault(),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:l,beforeSend:function(){j.html(c.loadingimg)},success:function(e){if(0==e.length)alert(M.util.get_string("error","moodle")),location.reload();else if(e.error){if(alert(e.error),e.noreload)return void j.html(m);location.reload()}else{var k=parseInt(e.result),l=c.rb_get_btn_hide(c.config.rb_reportid,k),n=c.rb_get_btn_delete(c.config.rb_reportid,k),o="",p=b.closest("tr").prev("tr");if(p.find(g.columnselector).length>0)var o=c.rb_get_btn_up(c.config.rb_reportid,k);j.remove(),h.prepend(l,n,o);var q=a("td:first",h.parents("tr:first")),r=a(g.columnselector,q),s=a(g.customheadingcheckselector,h.parents("tr:first"));r.parents(".fitem").removeClass("new_column_selector"),r.removeClass("new_column_selector"),r.attr("name","column"+k),r.attr("id","id_column"+k),q.find("select optgroup[label=New]").remove(),d.removeClass("new_advanced_selector"),d.attr("name","advanced"+k),d.attr("id","id_advanced"+k),s.attr("name","customheading"+k),s.removeAttr("id"),f.attr("name","heading"+k),f.attr("id","id_heading"+k),f.closest("tr").attr("colid",k),i.find("input[name=newheading]").val(""),q.closest("table").append(i),c.rb_reload_option_btns(p);var t=b.val().split("-")[0],u=b.val().split("-")[1];a(".new_column_selector optgroup option[value="+t+"-"+u+"]").remove(),a("select[name=defaultsortcolumn]").append('<option value="'+t+"_"+u+'">'+c.config.rb_column_headings[t+"-"+u]+"</option>"),c.rb_init_col_rows()}},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})}),j)},rb_init_deletebuttons:function(){function b(a){return(a+"").replace(/^([a-z])|\s+([a-z])/g,function(a){return a.toUpperCase()})}var e=this;a(".reportbuilderform table .deletecolbtn").off("click"),a(".reportbuilderform table .deletecolbtn").on("click",function(f){f.preventDefault();var h=a(this),i=M.util.get_string("confirm","moodle"),j=a(this).closest("tr"),k=M.util.get_string("confirmcoldelete","local_reportbuilder");c.create({title:i,body:k,type:c.types.CONFIRM}).done(function(c){c.getRoot().on(d.yes,function(){a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"delete",sesskey:e.config.user_sesskey,id:e.config.rb_reportid,cid:j.attr("colid")},beforeSend:function(){h.replaceWith(e.loadingimg)},success:function(c){if(c.success){var d=j.prev("tr"),f=j.next("tr");j.remove();var h=c.result;d.find(g.columnselector).length>0&&e.rb_reload_option_btns(d),f.find(g.columnselectornotnew).length>0&&e.rb_reload_option_btns(f);var i=b(h.optgroup_label),k=a(".new_column_selector optgroup[label='"+i+"']");0==k.length&&(k=a('<optgroup label="'+i+'"></optgroup>'),a(".new_column_selector").append(k)),0==k.find("option[value="+h.type+"-"+h.value+"]").length&&k.append('<option value="'+h.type+"-"+h.value+'">'+e.config.rb_column_headings[h.type+"-"+h.value]+"</option>"),a("select[name=defaultsortcolumn] option[value="+h.type+"_"+h.value+"]").remove(),e.rb_init_col_rows()}else"undefined"==typeof c.noalert&&alert(M.util.get_string("error","moodle")),location.reload()},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})}),c.show(),c.getRoot().on(d.hidden,function(){c.destroy()})})})},rb_init_hidebuttons:function(){var b=this;a(".reportbuilderform table .hidecolbtn").off("click"),a(".reportbuilderform table .hidecolbtn").on("click",function(c){c.preventDefault();var d=a(this),e=a(this).closest("tr");a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"hide",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:e.attr("colid")},beforeSend:function(){d.find("img").replaceWith(b.loadingimg)},success:function(a){if(a.success){var c=e.attr("colid"),f=b.rb_get_btn_show(b.config.rb_reportid,c);d.replaceWith(f),b.rb_init_col_rows()}else alert(M.util.get_string("error","moodle")),location.reload()},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_init_showbuttons:function(){var b=this;a(".reportbuilderform table .showcolbtn").off("click"),a(".reportbuilderform table .showcolbtn").on("click",function(c){c.preventDefault();var d=a(this),e=a(this).closest("tr");a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"show",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:e.attr("colid")},beforeSend:function(){d.find("img").replaceWith(b.loadingimg)},success:function(a){if(a.success){var c=e.attr("colid"),f=b.rb_get_btn_hide(b.config.rb_reportid,c);d.replaceWith(f),b.rb_init_col_rows()}else alert(M.util.get_string("error","moodle")),location.reload()},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_init_movedown_btns:function(){var b=this;a(".reportbuilderform table .movecoldownbtn").off("click"),a(".reportbuilderform table .movecoldownbtn").on("click",function(c){c.preventDefault();var d=(a(this),a(this).closest("tr")),e=d.clone();""!==d.find(g.columnselector).val()&&e.find(g.columnselector).find("option[value="+d.find(g.columnselector).val()+"]").attr("selected","selected"),""!==d.find(g.advancedselector).val()&&e.find(g.advancedselector).find("option[value="+d.find("div.advanced_selector select").val()+"]").attr("selected","selected");var f=d.next("tr"),h=f.clone();""!==f.find(g.columnselector).val()&&h.find(g.columnselector).find("option[value="+f.find("div.column_selector select").val()+"]").attr("selected","selected"),""!==f.find(g.advancedselector).val()&&h.find(g.advancedselector).find("option[value="+f.find("div.advanced_selector select").val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"movedown",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:d.attr("colid")},beforeSend:function(){f.html(b.loadingimg),d.html(b.loadingimg),e.find("td *").hide(),h.find("td *").hide()},success:function(a){a.success?(d.replaceWith(h),f.replaceWith(e),e.find("td *").fadeIn(),h.find("td *").fadeIn(),b.rb_reload_option_btns(e),b.rb_reload_option_btns(h),b.rb_init_col_rows()):(alert(M.util.get_string("error","moodle")),location.reload())},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_init_moveup_btns:function(){var b=this;a(".reportbuilderform table .movecolupbtn").off("click"),a(".reportbuilderform table .movecolupbtn").on("click",function(c){c.preventDefault();var d=(a(this),a(this).closest("tr")),e=d.clone();""!==d.find(g.columnselector).val()&&e.find(g.columnselector).find("option[value="+d.find(g.columnselector).val()+"]").attr("selected","selected"),""!==d.find(g.advancedselector).val()&&e.find(g.advancedselector).find("option[value="+d.find(g.advancedselector).val()+"]").attr("selected","selected");var f=d.prev("tr"),h=f.clone();""!==f.find(g.columnselector).val()&&h.find(g.columnselector).find("option[value="+f.find(g.columnselector).val()+"]").attr("selected","selected"),""!==f.find(g.advancedselector).val()&&h.find(g.advancedselector).find("option[value="+f.find("div.advanced_selector select").val()+"]").attr("selected","selected"),a.ajax({url:M.cfg.wwwroot+"/local/reportbuilder/ajax/column.php",type:"POST",data:{action:"moveup",sesskey:b.config.user_sesskey,id:b.config.rb_reportid,cid:d.attr("colid")},beforeSend:function(){f.html(b.loadingimg),d.html(b.loadingimg),e.find("td *").hide(),h.find("td *").hide()},success:function(a){a.success?(d.replaceWith(h),f.replaceWith(e),e.find("td *").fadeIn(),h.find("td *").fadeIn(),b.rb_reload_option_btns(e),b.rb_reload_option_btns(h),b.rb_init_col_rows()):(alert(M.util.get_string("error","moodle")),location.reload())},error:function(a,b,c){alert(M.util.get_string("error","moodle")),location.reload()}})})},rb_reload_option_btns:function(a){var b=a.children("td").filter(":last"),c=b.find(".hidecolbtn");0==c.length&&(c=b.find(".showcolbtn")),c=c.closest("a"),b.empty();var d=a.attr("colid"),e=this.rb_get_btn_delete(this.config.rb_reportid,d),f=this.spacer;a.prev("tr").find(g.columnselector).length>0&&(f=this.rb_get_btn_up(this.config.rb_reportid,d));var h=this.spacer;a.next("tr").next("tr").find(g.columnselector).length>0&&(h=this.rb_get_btn_down(this.config.rb_reportid,d)),b.append(c,e,f,h)},rb_get_btn_hide:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&h=1" title="'+M.util.get_string("hide","local_reportbuilder")+'" class="hidecolbtn action-icon">'+this.hideicon+"</a>")},rb_get_btn_show:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&h=0" title="'+M.util.get_string("show","local_reportbuilder")+'" class="showcolbtn action-icon">'+this.showicon+"</a>")},rb_get_btn_delete:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&d=1" title="'+M.util.get_string("delete","local_reportbuilder")+'" class="deletecolbtn action-icon">'+this.deleteicon+"</a>")},rb_get_btn_up:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&m=up" title="'+M.util.get_string("moveup","local_reportbuilder")+'" class="movecolupbtn action-icon">'+this.upicon+"</a>")},rb_get_btn_down:function(b,c){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+"&cid="+c+'&m=down" title="'+M.util.get_string("movedown","local_reportbuilder")+'" class="movecoldownbtn action-icon">'+this.downicon+"</a>")},rb_get_btn_add:function(b){return a('<a href="'+M.cfg.wwwroot+"/local/reportbuilder/columns.php?id="+b+'" class="addcolbtn"><input class="btn btn-secondary" type="button" value="'+M.util.get_string("add","local_reportbuilder")+'" /></a>')}};return g});