define(["jquery","theme_bootstrap/bootstrap","local_wa_learning_path/helper","core/str","jqueryui"],function(t,i,e,a,d){return{initVariables:function(t,i,e,a,d,s,o,n,r,c){this.wa_max_id=t,this.wa_status=i,this.wa_isloading=!1,this.limitText=e,this.requiredText=a,this.selfledText=d,this.saveText=s,this.cancelText=o,this.removeText=n,this.closeText=r,0==Object.keys(c).length?this.waActivities={}:this.waActivities=c},deleteConfirmed:function(i){1==t(i).parent().find("> div").length&&t(i).parent().find("span").show(),t(".results a[courseid='"+t(i).find("div").attr("courseid")+"']").removeClass("added"),t(".results a[activityid='"+t(i).find("div").attr("activityid")+"']").removeClass("added"),t(i).remove()},addColumn:function(i,a){if(t(".wa_matrix .col_header").length>=15)this.showLimitInfo();else{i.id||(i.id=this.generateId());var d=t(".wa_hide .col_header").clone();d.attr("id",i.id),d.find(".tooltip").html(i.name),d.attr("title",i.name);d.find(".name").html();var s=i.name.replace(/^(.{18}[.]*).*/,"$1");s.length<i.name.length&&(s+="..."),d.find(".name .text").html(s),i.region&&(d.find(".select").val(i.region),i.region.forEach(function(t){d.find('span[id="'+t+'"]').removeClass("hide")})),i.show?(d.attr("show","yes"),d.find(".wa_show").hide()):(d.attr("show","no"),d.find(".wa_hide2").hide()),i.description?d.attr("description",i.description):d.attr("description",""),d.attr("data-column",i.id),d.appendTo(t(".wa_matrix .cols")),t(".wa_matrix .wa_row").length&&t(".wa_matrix").find("> div").each(function(){if(!t(this).hasClass("cols")){var e=t('<div class="cell" data-row="'+t(this).attr("id")+'" data-column="'+i.id+'">'+a+"</div>");t(e).find("a").attr("href","#"+i.id+"_"+t(this).attr("id")),t(e).appendTo(t(this))}})}return i.isnew&&e.updateRegionVisibility(i.id,i.region),e.setHiddenCells(),this.setUpMatrixSelection(),e.calculateWidthAndHeight(),i.id},setUpMatrixSelection:function(){t(".cell").on("mouseenter",function(){var i=t(this).data("column"),e=t(this).parent().attr("id");t(".wa_matrix div").each(function(){t(this).removeClass("cell-highlight"),t(this).removeClass("marked-cell"),t(this).data("column")==i&&t(this).addClass("cell-highlight"),t(this).data("row")==e&&t(this).addClass("cell-highlight")}),t(this).removeClass("cell-highlight"),t(this).addClass("marked-cell")}),t(".cell").on("mouseleave",function(){t(".wa_matrix div").each(function(){t(this).removeClass("marked-cell"),t(this).removeClass("cell-highlight")})})},addRow:function(i,a,d,s,o,n){if(!(t(".wa_matrix .wa_row").length>=15)){i.id||(i.id=this.generateId());var r=t(".wa_matrix").width(),c=t('<div class="wa_row" data-row="'+i.id+'" id="'+i.id+'" />'),l=t(".wa_hide .row_header").clone();l.find(".tooltip").html(i.name),l.attr("title",i.name);l.find(".name").html();var h=i.name.replace(/^(.{20}[.]*).*/,"$1");return h.length<i.name.length&&(h+="..."),l.find(".tooltip").html(i.name),l.find(".name .text").html(h),i.show?(l.attr("show","yes"),l.find(".wa_show").hide()):(l.attr("show","no"),l.find(".wa_hide2").hide()),l.attr("data-row",i.id),l.appendTo(c),i.show||l.parent().addClass("greyed"),t(".wa_matrix .col_header").each(function(){var e=t('<div class="cell" data-row="'+i.id+'" data-column="'+t(this).attr("id")+'">'+s+"</div>");if(0==a)t(e).find("a").attr("href","#"+t(this).attr("id")+"_"+i.id);else{var r="#"+t(this).attr("id")+"_"+i.id;if(-1!==t.inArray(r.toString(),d)){t(e).addClass("cell-selected");var l=n+"&a=edit_activity&id="+o+"&roleid="+a+"&activityid="+t(this).attr("id")+"_"+i.id;t(e).find("a").attr("href",l)}else t(e).find("a").remove()}e.appendTo(c)}),c.appendTo(t(".wa_matrix")),t(".wa_matrix").width(r),e.setHiddenCells(),this.setUpMatrixSelection(),e.calculateWidthAndHeight(),i.id}this.showLimitInfo()},waCheckIcons:function(i,e,a,d,s){for(var o in this.waActivities){var n=this.waActivities[o];location.hash&&location.hash!=o||(0==i?n.positions.essential.length||n.positions.recommended.length||n.positions.elective.length?t('a[href="'+o+'"] i').attr("class",e):n.content?t('a[href="'+o+'"] i').attr("class",a):t('a[href="'+o+'"] i').attr("class",d):t('a[href="'+o+'"] i').attr("class",s))}},setMaxId:function(t){this.wa_max_id=t},generateId:function(){return this.wa_max_id++,"g"+this.wa_max_id.toString()},showLimitInfo:function(){t("#dialog_info").html(this.limitText);var i={Close:function(){t(this).dialog("close")}};t("#dialog_info").dialog({resizable:!1,width:"650px",buttons:i})},setModule:function(t){this.wa_to_add=JSON.parse(t)},getModule:function(){return this.wa_to_add},setToAddActivity:function(t){this.wa_to_add_activity=JSON.parse(t)},getToAddActivity:function(){return this.wa_to_add_activity},saveNewActivity:function(i,e){var a=this;if(!this.blockNewActivity){this.blockNewActivity=!0,"undefined"!=typeof tinymce&&tinymce.get("activity_description_id").save();var d=t("#dialog_create_activity_id .wa_activity_mform");t(d).find('input[name="region"]').attr("name","temp");var s=d.serialize();t(d).find('input[name="temp"]').attr("name","region"),t.ajax({type:"POST",url:d.prop("action")+"&lpid="+a.lpathid,data:s,dataType:"json",success:function(i){if(a.blockNewActivity=!1,i.status&&"OK"===i.status){t("#dialog_create_activity_id").addClass("hide");var d=t('<a date="'+e+'" href="" activityid="'+i.activity.id+'">'+i.activity.title+"</a>").click(function(){var i={activityid:t(this).attr("activityid"),html:t(this).html()};return a.wa_to_add_activity=i,t("#activitiyform .activity a").removeClass("selected"),t(this).addClass("selected"),t("#activitiyform .activity button").show(),!1});return t(".activity.tab .selectpicker").val(""),t(".activity.tab .results a").hide(),t(".activity.tab .results").append(d),t(".activity.tab .results").slideDown().find("span").hide(),!1}if(i.status&&"ERROR"===i.status){var s;for(s in i.errors){var o=t("<span>").addClass("error").html(i.errors[s]);t('#dialog_create_activity [name="'+s+'"]').parent().find("span.error, br").remove(),t('#dialog_create_activity [name="'+s+'"]').parent().prepend(o)}return t("#dialog_create_activity").scrollTop(0),!1}alert("ERROR")},error:function(t,i,e){this.blockNewActivity=!1}})}},titleValidation:function(){var i=t('#dialog_create_activity input[name="title"]');if(t(i).parent().find("span.error, br").remove(),""===t(i).val()){var e=t("<span>").addClass("error").html(this.requiredText);t(i).parent().prepend(e)}},activityClearForm:function(){t('.wa_activity_mform input[name="title"]').val(""),t('.wa_activity_mform select[name="region[]"]').val("0"),t('.wa_activity_mform select[name="type"]').val("video"),t(".wa_activity_mform #id_description_editoreditable").html(""),t('.wa_activity_mform input[name="provider"]').val(this.selfledText),t('.wa_activity_mform input[name="enablecdp"]').prop("checked",!1),t('.wa_activity_mform select[name="learningmethod"]').val("SELF-LED"),t('.wa_activity_mform input[name="duration"]').val(""),t('.wa_activity_mform select[name="unit"]').val("MIN"),t('.wa_activity_mform select[name="subject"]').val("PD"),t(".wa_activity_mform #id_learningdescriptioneditable").html("")},createActivity:function(){this.saveText,this.cancelText;return this.activityClearForm(),t("#dialog_create_activity_id").removeClass("hide"),!1},addPosition:function(i,e){1==e?(t("#activitiyform .added .essential span").hide(),t("#activitiyform .added .essential").append(i)):2==e?(t("#activitiyform .added .recommended span").hide(),t("#activitiyform .added .recommended").append(i)):(t("#activitiyform .added .elective span").hide(),t("#activitiyform .added .elective").append(i))},getDateForNew:function(){if(2==this.wa_status){var t=new Date;return Math.round(t.getTime()/1e3)}return 0},addModule:function(i,e,a,d,s){var o=1==s?this.getDateForNew():s;if(!(t('#activitiyform .added div[courseid="'+i+'"]').length>0)){var n=t('<div id="module'+i+'"><div class="module" date="'+o+'" courseid="'+i+'"><div class="methodology">'+d+'</div><div class="name">'+a+'</div><div><button class="removeModule">'+this.removeText+"</button></div></div></div>");return t('.results a[courseid="'+i+'"]').addClass("added"),this.addPosition(n,e),this.initialiseRemove("module",i),!0}this.alreadyAddedMessage()},addActivity:function(i,e,a,d,s){if(!(t('#activitiyform .added div[activityid="'+i+'"]').length>0)){var o=1==s?this.getDateForNew():s,n=t('<div id="activity'+i+'"><div class="activity" date="'+o+'" activityid="'+i+'" percent="'+d+'"><div class="title">'+a+" ("+d+' %)</div><div><button class="removeModule">'+this.removeText+"</button></div></div></div>");return t('.results a[activityid="'+i+'"]').addClass("added"),this.addPosition(n,e),this.initialiseRemove("activity",i),!0}this.alreadyAddedMessage()},initialiseRemove:function(i,e){var a=this,d=t("#"+i+e);t("#"+i+e+" .removeModule").on("click",function(){return t("#dialog-confirm").dialog({resizable:!1,height:200,width:500,modal:!0,autoOpen:!1,buttons:{Yes:function(){a.deleteConfirmed(d),t(this).dialog("close")},No:function(){t(this).dialog("close")}}}).dialog("open"),!1})},waSave:function(){var i=[];t(".wa_matrix .col_header").each(function(){var e={id:t(this).attr("id"),region:t(this).find(".select").val(),name:t(this).find(".name .tooltip").html(),description:t(this).attr("description"),show:"yes"==t(this).attr("show")};i.push(e)});var e=[];t(".wa_matrix .row_header").each(function(){var i={id:t(this).parent().attr("id"),name:t(this).find(".name .tooltip").html(),show:"yes"==t(this).attr("show")};e.push(i)});var a={cols:i,rows:e,activities:this.waActivities,max_id:this.wa_max_id,itemid:t('input[name="description_editor[itemid]"]').val()};t('#matrixform input[name="matrix"]').val(JSON.stringify(a))},waSaveAjax:function(i,e,a){this.waSave();var d=t('#matrixform input[name="matrix"]').val(),s=t('#matrixform input[name="id"]').val(),o=t("#matrixform").attr("action")+"?c=admin&a=save_matrix_ajax&id="+s;t.ajax({type:"POST",url:o,data:{matrix:d},success:function(d){noticeDiv=t(".alert-success");(new Date).toUTCString();noticeDiv.length?noticeDiv.text(e+" "+a+" has been "+i):t('<div class="alert alert-success">'+e+" "+a+" has been "+i+"</div>").prependTo(t("#editing_matrix"))},error:function(t,i,e){}})},alreadyAddedMessage:function(){var i=[{text:this.closeText,click:function(){t(this).dialog("close")}}];t("#dialog-message").dialog({resizable:!1,height:180,width:450,modal:!1,buttons:i})},chooseElementToAdd:function(){var i=[{text:this.closeText,click:function(){t(this).dialog("close")}}];t("#dialog-message2").dialog({resizable:!1,height:180,width:450,modal:!1,buttons:i})},editActivity:function(){var i=location.hash;if("#save"==i)t("#id_submitbutton").click();else if(i&&"#cancel"!=i&&"#"!=i){t(".selectpicker").val("");var e=t('.wa_matrix a[href="'+i+'"]'),a=t(e).parents(".wa_row").find(".name .tooltip").html(),d=t(e).parents(".cell").index()+1,s=t(".wa_matrix .cols div:nth-child("+d+") .name .tooltip").html();t("#editing_activity h2").html(a+", "+s),t("#editing_matrix").hide(),t("#editing_activity").fadeIn();var o="";this.waActivities[location.hash]&&(o=this.waActivities[location.hash].content),t("#id_content_editoreditable").html(o),t("#id_content_editor_ifr").contents().find("body").html(o),t("#activitiyform .essential > div").remove(),t("#activitiyform .recommended > div").remove(),t("#activitiyform .elective > div").remove(),t("#activitiyform .added span").show();var n=this;this.waActivities[location.hash]&&(this.waActivities[location.hash].positions.essential.length&&(t("#activitiyform .added .essential span").hide(),t.each(this.waActivities[location.hash].positions.essential,function(){if("module"==this.type){var i=t('.modules a[courseid="'+this.id+'"]');n.addModule(this.id,1,i.html(),this.methodology,this.date)}else{i=t('.activity a[activityid="'+this.id+'"]');n.addActivity(this.id,1,i.html(),this.percent,this.date)}})),this.waActivities[location.hash].positions.recommended.length&&(t("#activitiyform .added .recommended span").hide(),t.each(this.waActivities[location.hash].positions.recommended,function(){if("module"==this.type){var i=t('.modules a[courseid="'+this.id+'"]');n.addModule(this.id,2,i.html(),this.methodology,this.date)}else{i=t('.activity a[activityid="'+this.id+'"]');n.addActivity(this.id,2,i.html(),this.percent,this.date)}})),this.waActivities[location.hash].positions.elective.length&&(t("#activitiyform .added .elective span").hide(),t.each(this.waActivities[location.hash].positions.elective,function(){if("module"==this.type){var i=t('.modules a[courseid="'+this.id+'"]');n.addModule(this.id,3,i.html(),this.methodology,this.date)}else{i=t('.activity a[activityid="'+this.id+'"]');n.addActivity(this.id,3,i.html(),this.percent,this.date)}})))}else t("#editing_activity").hide(),t("#editing_matrix").fadeIn()},saveActivity:function(){var i=[];t("#activitiyform .essential > div").each(function(){var e=t(this).find("> div");t(e).hasClass("module")?i.push({type:"module",id:t(e).attr("courseid"),date:t(e).attr("date"),methodology:t(e).find(".methodology").html()}):i.push({type:"activity",id:t(e).attr("activityid"),date:t(e).attr("date"),percent:t(e).attr("percent")})});var e=[];t("#activitiyform .recommended > div").each(function(){var i=t(this).find("> div");t(i).hasClass("module")?e.push({type:"module",id:t(i).attr("courseid"),date:t(i).attr("date"),methodology:t(i).find(".methodology").html()}):e.push({type:"activity",id:t(i).attr("activityid"),date:t(i).attr("date"),percent:t(i).attr("percent")})});var a=[];t("#activitiyform .elective > div").each(function(){var i=t(this).find("> div");t(i).hasClass("module")?a.push({type:"module",id:t(i).attr("courseid"),date:t(i).attr("date"),methodology:t(i).find(".methodology").html()}):a.push({type:"activity",id:t(i).attr("activityid"),date:t(i).attr("date"),percent:t(i).attr("percent")})});var d="";t("#id_content_editoreditable").length&&(d=t("#id_content_editoreditable").html()),t("#id_content_editor_ifr").length&&(d=t("#id_content_editor_ifr").contents().find("body").html()),this.waActivities[location.hash]={content:d,positions:{essential:i,recommended:e,elective:a}},this.waSave(),location.hash="#save"}}});