define(["jquery","core/config","core/str","core/notification","local_onlineappraisal/datepicker"],function(a,b,c,d,e){var f=function(b){var c=a("<span></span>").css({position:"absolute",left:"-99999px",whiteSpace:"pre",width:"auto"}).addClass(b.prop("class")).html(b.val()).insertAfter(b),d=c.width();return c.remove(),d};return{init:function(g){a("form.admin_group .fitem_actionbuttons").hide(),a("#id_groupid").change(function(){a(this).closest("form").submit()}),a("#id_cohortid").change(function(){a(this).closest("form").submit()}),a("#oa-appraisal-select-all").click(function(){a(".oa-appraisal-select").filter(":visible").prop("checked",a(this).prop("checked")),a(".oa-appraisal-select").filter(":hidden").prop("checked",!1)}),a("form#oa-filter").removeClass("hidden"),a("#oa-inprogress-table tbody tr.oa-empty-filter").hide().removeClass("hidden"),a("#oa-filter-select").change(function(){var b=a(this),c=b.val();"0"===c?a("#oa-inprogress-table tbody tr").show():"action"===c?(a("#oa-inprogress-table tbody tr").hide(),a("#oa-inprogress-table tbody tr.info").show()):(a("#oa-inprogress-table tbody tr").hide(),a("#oa-inprogress-table tbody tr").filter(function(){return c>=7?a(this).data("status")>=c:a(this).data("status")==c}).show()),a('#oa-inprogress-table tbody tr:not(".oa-empty-filter"):visible()').length?a("#oa-inprogress-table tbody tr.oa-empty-filter").hide():a("#oa-inprogress-table tbody tr.oa-empty-filter").show(),a(".oa-appraisal-select").prop("checked",!1),a("#oa-appraisal-select-all").prop("checked",!1)});var h=a("#oa-init-duedate");if(h.prop("readonly",!0).css({backgroundColor:"#ffffff",cursor:"pointer"}),h.datepicker({autoclose:!0,format:{toDisplay:function(a,b,c){return e.toDisplay(a,b.format,c)},toValue:function(a,b,c,d){return e.toValue(a,b.format,c,d)},format:g.dateformat},todayHighlight:!0,startDate:new Date,zIndexOffset:1030,language:a("html").prop("lang").replace("-","_")}).on("changeDate",function(){h.prev("input[name=duedate]").val(h.datepicker("getUTCDate").getTime()/1e3)}),h.data("y")&&h.data("m")&&h.data("d")){var i=new Date(h.data("y"),h.data("m")-1,h.data("d"));h.datepicker("update",i)}h.next(".input-group-addon").on("click",function(){h.focus()}),a("form.oa-form-allstaff").submit(function(b){var c=a(this),d=c.find("button");if(!c.data("submit")){b.preventDefault();var e=d.html();d.prop("disabled",!0),d.html('<i class="fa fa-lg fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+c.data("button")+"</span>");var f=a("#oa-init-duedate"),g=f.datepicker("getUTCDate");if("[object Date]"!==Object.prototype.toString.call(g)){var h=a("#header").outerHeight(!0);return f.closest(".form-group").addClass("has-error").find(".help-block").hide().removeClass("hidden").show(),a("html, body").animate({scrollTop:f.offset().top-h},500),d.html(e),d.prop("disabled",!1),d.blur(),void f.datepicker().on("changeDate",function(){f.closest(".form-group").removeClass("has-error").find(".help-block").hide(),a("html, body").animate({scrollTop:d.offset().top-h},500)})}if(d.data("confirm")){var i=window.confirm(d.data("confirm"));if(!i)return d.html(e),d.prop("disabled",!1),void d.blur()}c.data("submit",!0),c.submit()}}),a(".oa-init-appraisal").click(function(){var e=a(this),f=e.closest("tr"),g=f.find("td").length,h=a('<tr class="tr-alert"><td colspan="'+g+'"><div class="alert" role="alert"></div></td></tr>').hide(),i=h.find(".alert"),j=e.html();e.prop("disabled",!0),c.get_string("admin:initialisingdots","local_onlineappraisal").done(function(a){e.html('<i class="fa fa-lg fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+a+"</span>")}).fail(d.exception);var k=a("input[name=currentgroupid]").val(),l=a("input[name=currentcohortid]").val(),m=e.data("id"),n=a("#oa-appraiser-select-"+m).val(),o=a("#oa-signoff-select-"+m).val(),p=a("#oa-groupleader-select-"+m).val(),q=a("#oa-init-duedate"),r=q.datepicker("getUTCDate");if(1>n||1>o)return void c.get_string("error:selectusers","local_onlineappraisal").done(function(b){i.removeClass("alert-success").addClass("alert-danger"),i.html(b),f.next(".tr-alert").remove(),h.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),e.html(j),e.prop("disabled",!1),e.blur()}).fail(d.exception);if("[object Date]"!==Object.prototype.toString.call(r)){var s=a("#header").outerHeight(!0);return q.closest(".form-group").addClass("has-error").find(".help-block").hide().removeClass("hidden").show(),a("html, body").animate({scrollTop:q.offset().top-s},500),e.html(j),e.prop("disabled",!1),e.blur(),void q.datepicker().on("changeDate",function(){q.closest(".form-group").removeClass("has-error").find(".help-block").hide(),a("html, body").animate({scrollTop:e.offset().top-s},500)})}c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"admin",a:"initialise_appraisal",groupid:k,cohortid:l,appraiseeid:m,appraiserid:n,signoffid:o,groupleaderid:p,duedate:r.getTime()/1e3},success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?(i.removeClass("alert-danger").addClass("alert-success"),f.find("select").prop("disabled",!0),e.remove()):(i.removeClass("alert-success").addClass("alert-danger"),e.html(j),e.prop("disabled",!1),e.blur()),i.html(b.message),f.next(".tr-alert").remove(),h.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},error:function(){i.removeClass("alert-success").addClass("alert-danger"),i.html(c),f.next(".tr-alert").remove(),h.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),e.html(j),e.prop("disabled",!1),e.blur()}})}).fail(d.exception)}),a(".oa-inline-edit").click(function(){var b=a(this),c=b.closest("tr");b.hide(),b.siblings(".oa-delete").hide(),b.siblings(".oa-inline-save, .oa-inline-undo").removeClass("hidden").show(),c.find(".form-group").removeClass("hidden").show().siblings("span").hide();var d=c.find(".datepicker");if(d.length){var h=d.siblings("span");if(d.removeClass("hidden").show(),h.hide(),d.datepicker({autoclose:!1,format:{toDisplay:function(a,b,c){return e.toDisplay(a,b.format,c)},toValue:function(a,b,c,d){return e.toValue(a,b.format,c,d)},format:g.dateformat},startDate:0,todayHighlight:!0,zIndexOffset:1030,language:a("html").prop("lang").replace("-","_")}).on("changeDate",function(a){d.width(f(d)),h.html(a.format())}),d.data("y")&&d.data("m")&&d.data("d")){var i=new Date(d.data("y"),d.data("m")-1,d.data("d"));d.datepicker("update",i),d.width(f(d))}else d.width(50)}}),a(".oa-inline-undo").click(function(){var b=a(this),c=b.closest("tr");c.find(".form-group").hide().siblings("span").show(),b.hide(),b.siblings(".oa-inline-save").hide(),b.siblings(".oa-inline-edit, .oa-delete").show();var d=c.find(".datepicker");if(d.length){var e=d.siblings("span");if(d.data("y")&&d.data("m")&&d.data("d")){var f=new Date(d.data("y"),d.data("m")-1,d.data("d"));d.datepicker("update",f),e.html(d.datepicker("getFormattedDate"))}else d.datepicker("update",""),e.html("-");d.datepicker("destroy"),d.hide(),e.show()}}),a(".oa-inline-save").click(function(){var e=a(this),f=e.closest("tr"),g=f.find(".datepicker"),h=f.find("td").length,i=a('<tr class="tr-alert"><td colspan="'+h+'"><div class="alert" role="alert"></div></td></tr>').hide(),j=i.find(".alert"),k=e.html();e.prop("disabled",!0),c.get_string("admin:savingdots","local_onlineappraisal").done(function(a){e.html('<i class="fa fa-lg fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+a+"</span>")}).fail(d.exception);var l=f.data("appraisalid"),m={c:"admin",a:"update_appraisal",appraisalid:l,appraiserid:a("#oa-appraiser-select-"+l).val(),signoffid:a("#oa-signoff-select-"+l).val(),groupleaderid:a("#oa-groupleader-select-"+l).val()};if(m.appraiserid<1||m.signoffid<1)return void c.get_string("error:selectusers","local_onlineappraisal").done(function(b){j.removeClass("alert-success").addClass("alert-danger"),j.html(b),f.next(".tr-alert").remove(),i.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),e.html(k),e.prop("disabled",!1),e.blur()}).fail(d.exception);var n=null;if(g.length){var o=g.siblings("span");if(n=g.datepicker("getUTCDate"),null!==n&&"[object Date]"!==Object.prototype.toString.call(n))return void c.get_string("error:f2fdate","local_onlineappraisal").done(function(b){j.removeClass("alert-success").addClass("alert-danger"),j.html(b),f.next(".tr-alert").remove(),i.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),e.html(k),e.prop("disabled",!1),e.blur()}).fail(d.exception);null!==n&&(m.date=n.getTime()/1e3)}c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:m,success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?(j.removeClass("alert-danger").addClass("alert-success"),f.find(".form-group").each(function(){var b=a(this),c=b.find("option").filter(":selected").text();b.hide(),b.siblings("span").text(c).show()}),null!==n&&(g.data("d",n.getDate()),g.data("m",n.getMonth()+1),g.data("y",n.getFullYear())),g.length&&(g.datepicker("destroy"),g.hide(),o.show()),e.hide(),e.siblings(".oa-inline-undo").hide(),e.siblings(".oa-inline-edit, .oa-delete").show()):j.removeClass("alert-success").addClass("alert-danger"),j.html(b.message),f.next(".tr-alert").remove(),i.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},error:function(){j.removeClass("alert-success").addClass("alert-danger"),j.html(c),f.next(".tr-alert").remove(),i.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},complete:function(){e.html(k),e.prop("disabled",!1),e.blur()}})}).fail(d.exception)}),a(".oa-delete").click(function(){var e=a(this),f=e.closest("tr"),g=f.find("td").length,h=a('<tr class="tr-alert"><td colspan="'+g+'"><div class="alert" role="alert"></div></td></tr>').hide(),i=h.find(".alert"),j=e.html();e.prop("disabled",!0),c.get_string("admin:deletingdots","local_onlineappraisal").done(function(a){e.html('<i class="fa fa-lg fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+a+"</span>")}).fail(d.exception),c.get_strings([{key:"admin:confirm:delete",component:"local_onlineappraisal"},{key:"error:request",component:"local_onlineappraisal"}]).done(function(c){var d=window.confirm(c[0]);if(!d)return e.html(j),e.prop("disabled",!1),void e.blur();var g=f.data("appraisalid"),k=e.data("method");a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"admin",a:"delete_appraisal",appraisalid:g,method:k},success:function(b){"object"!=typeof b&&(b={success:!1,message:c[1],data:""}),b.success?i.removeClass("alert-danger").addClass("alert-success"):i.removeClass("alert-success").addClass("alert-danger"),i.html(b.message),f.next(".tr-alert").remove(),h.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),b.success&&f.remove()},error:function(){i.removeClass("alert-success").addClass("alert-danger"),i.html(c[1]),f.next(".tr-alert").remove(),h.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},complete:function(){e.html(j),e.prop("disabled",!1),e.blur()}})}).fail(d.exception)}),a("#oa-bulk-actions").submit(function(b){b.preventDefault();var e=a(this).find("button"),f=e.html();e.prop("disabled",!0),c.get_string("admin:processingdots","local_onlineappraisal").done(function(a){e.html('<i class="fa fa-lg fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+a+"</span>")}).fail(d.exception);var g=a("#oa-bulk-actions-select option").filter(":selected").val(),h=a(".oa-bulk-table").find("input[type=checkbox].oa-appraisal-select").filter(":checked"),i=a("#oa-bulk-alert");if(i.hide().removeClass("hidden"),""===g)return void c.get_string("error:noaction","local_onlineappraisal").done(function(a){i.find(".alert-message").text(a),i.removeClass("alert-success").addClass("alert-danger"),i.slideDown().delay(5e3).slideUp(),e.html(f),e.prop("disabled",!1),e.blur()}).fail(d.exception);if(h.length<1)return void c.get_string("error:noselection","local_onlineappraisal").done(function(a){i.find(".alert-message").text(a),i.removeClass("alert-success").addClass("alert-danger"),i.slideDown().delay(5e3).slideUp(),e.html(f),e.prop("disabled",!1),e.blur()}).fail(d.exception);if("email"===g){var j=[],k=h.closest("tr");if(k.each(function(){j.push(a(this).find(".appraisee").data("email"))}),j.length>0){var l="mailto:"+j.join("%3B")+"%3B",m=window.open(l,"emailWindow");m&&m.open&&!m.closed&&m.close()}return e.html(f),e.prop("disabled",!1),void e.blur()}}),a("table").on("click",".oa-toggle-required",function(e){e.preventDefault();var f=a(this);if(!f.data("processing")){var g=f.closest("tr");f.data("processing",!0);var h;c.get_string("admin:processingdots","local_onlineappraisal").done(function(b){h=a('<i class="fa fa-2x fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+b+"</span>"),f.hide().after(h)}).fail(d.exception);var i=g.find("td").length,j=a('<tr class="tr-alert"><td colspan="'+i+'"><div class="alert" role="alert"></div></td></tr>').hide(),k=j.find(".alert"),l=f.data("userid"),m=f.data("confirm");"undefined"==typeof m&&(m=0);var n=f.data("reason");"undefined"==typeof n&&(n=""),f.removeData("confirm"),f.removeData("reason"),c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"admin",a:"toggle_appraisal_required",userid:l,confirm:m,reason:n},success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?(k.removeClass("alert-danger").addClass("alert-success"),f.toggleClass("fa-check text-success fa-times text-danger").data("processing",!1).show().find("span.sr-only").html(b.data),"tooltip"===f.data("toggle")&&(f.tooltip("hide"),f.tooltip("destroy"),f.removeAttr("toggle").removeData("toggle").removeAttr("title")),""!==n&&(f.attr("title",n),f.data("toggle","tooltip"),f.tooltip()),f.data("remove-toggle")&&f.removeClass("oa-toggle-required"),h.remove()):(k.removeClass("alert-success").addClass("alert-danger"),h.remove(),f.data("processing",!1).show()),k.html(b.message),g.next(".tr-alert").remove(),"confirm"===b.data||"reason"===b.data?j.insertAfter(g).slideDown():j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},error:function(){k.removeClass("alert-success").addClass("alert-danger"),k.html(c),g.next(".tr-alert").remove(),j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),h.remove(),f.data("processing",!1).show()}})}).fail(d.exception)}}),a("table").on("click",".oa-toggle-required-reason",function(b){b.preventDefault();var c=a(this),d=c.closest("tr");if(c.data("reason")){var e=c.siblings("input[name=reason]").val();d.closest("table").find(".oa-toggle-required").filter(function(){return a(this).data("userid")===c.data("userid")}).data("reason",e).data("confirm",1).click()}d.slideUp(function(){a(this).remove()})}),a("table").on("click",".oa-toggle-required-confirm",function(b){b.preventDefault();var c=a(this),d=c.closest("tr");c.data("confirm")&&d.closest("table").find(".oa-toggle-required").filter(function(){return a(this).data("userid")===c.data("userid")}).data("confirm",1).click(),d.slideUp(function(){a(this).remove()})}),a(".oa-toggle-vip").click(function(e){e.preventDefault();var f=a(this);if(!f.data("processing")){var g=f.closest("tr");f.data("processing",!0);var h;c.get_string("admin:processingdots","local_onlineappraisal").done(function(b){h=a('<i class="fa fa-2x fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+b+"</span>"),f.hide().after(h)}).fail(d.exception);var i=g.find("td").length,j=a('<tr class="tr-alert"><td colspan="'+i+'"><div class="alert" role="alert"></div></td></tr>').hide(),k=j.find(".alert"),l=f.data("userid");c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"admin",a:"toggle_appraisal_vip",userid:l},success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?(k.removeClass("alert-danger").addClass("alert-success"),f.toggleClass("oa-vip-yes").data("processing",!1).show().find("span.sr-only").html(b.data),h.remove()):(k.removeClass("alert-success").addClass("alert-danger"),h.remove(),f.data("processing",!1).show()),k.html(b.message),g.next(".tr-alert").remove(),j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},error:function(){k.removeClass("alert-success").addClass("alert-danger"),k.html(c),g.next(".tr-alert").remove(),j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),h.remove(),f.data("processing",!1).show()}})}).fail(d.exception)}}),a("[id^=oa-signoff-select-]").on("change",function(){var b=a(this),c=b.val(),d=b.closest("tr").find("[id^=oa-groupleader-select-]");d.prop("disabled",!1);var e=d.find("option"),f=d.find('option[value="'+c+'"]');"0"!==c&&f.length>0?(f.hide().prop("selected",!1),f.siblings().show()):e.show(),1===e.filter(":visible").length&&d.prop("disabled",!0)}),a(".oa-toggle-assign").click(function(e){e.preventDefault();var f=a(this);if(!f.data("processing")){var g=f.closest("tr");f.data("processing",!0);var h=f.next(".sr-only").html();c.get_string("admin:processingdots","local_onlineappraisal").done(function(a){f.removeClass("fa-plus-square fa-minus-square").addClass("fa-spinner fa-spin").next(".sr-only").html(a)}).fail(d.exception);var i=g.find("td").length,j=a('<tr class="tr-alert"><td colspan="'+i+'"><div class="alert" role="alert"></div></td></tr>').hide(),k=j.find(".alert"),l=f.data("assign"),m=f.data("userid"),n=f.data("confirm");"undefined"==typeof n&&(n=0);var o=f.data("reason");"undefined"==typeof o&&(o=""),f.removeData("confirm"),f.removeData("reason");var p="fa-minus-square";l&&(p="fa-plus-square"),c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"admin",a:"appraisalcycle_assign",userid:m,assign:l,confirm:n,reason:o},success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?window.location=b.data:(k.removeClass("alert-success").addClass("alert-danger"),f.data("processing",!1).removeClass("fa-fw fa-spinner fa-spin").addClass(p).next(".sr-only").html(h),k.html(b.message),g.next(".tr-alert").remove(),"confirm"===b.data||"reason"===b.data?j.insertAfter(g).slideDown():j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()}))},error:function(){k.removeClass("alert-success").addClass("alert-danger"),k.html(c),g.next(".tr-alert").remove(),j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),f.data("processing",!1).removeClass("fa-fw fa-spinner fa-spin").addClass(p).next(".sr-only").html(h)}})}).fail(d.exception)}}),a("table").on("click",".oa-toggle-assign-reason",function(b){b.preventDefault();var c=a(this),d=c.closest("tr");if(c.data("reason")){var e=c.siblings("input[name=reason]").val();d.closest("table").find(".oa-toggle-assign").filter(function(){return a(this).data("userid")===c.data("userid")}).data("reason",e).data("confirm",1).click()}d.slideUp(function(){a(this).remove()})}),a("table").on("click",".oa-toggle-assign-confirm",function(b){b.preventDefault();var c=a(this),d=c.closest("tr");c.data("confirm")&&d.closest("table").find(".oa-toggle-assign").filter(function(){return a(this).data("userid")===c.data("userid")}).data("confirm",1).click(),d.slideUp(function(){a(this).remove()})})}}});