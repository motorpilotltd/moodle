define(["jquery","core/config","core/str","core/notification","local_onlineappraisal/datepicker"],function(a,b,c,d,e){return{init:function(f){a("form.admin_group .fitem_actionbuttons").hide(),a("#id_groupid").change(function(){a(this).closest("form").submit()}),a("form#oa-filter").removeClass("hidden"),a("#oa-current-table tbody tr.oa-empty-filter").hide().removeClass("hidden"),a("#oa-filter-select").change(function(){var b=a(this),c=b.val();"0"===c?a("#oa-current-table tbody tr").show():"action"===c?(a("#oa-current-table tbody tr").hide(),a("#oa-current-table tbody tr.info").show()):(a("#oa-current-table tbody tr").hide(),a("#oa-current-table tbody tr").filter(function(){return c>=7?a(this).data("status")>=c:a(this).data("status")==c}).show()),a('#oa-current-table tbody tr:not(".oa-empty-filter"):visible()').length?a("#oa-current-table tbody tr.oa-empty-filter").hide():a("#oa-current-table tbody tr.oa-empty-filter").show()}),a("i.oa-togglef2f").css("cursor","pointer"),a(".oa-togglef2f.disabled").css("cursor","not-allowed"),a(".oa-togglef2f").click(function(e){if(e.preventDefault(),!a(this).data("processing")&&!a(this).hasClass("disabled")){var f=a(this).closest("tr"),g=f.find("i.oa-togglef2f"),h=f.find("a.oa-togglef2f");g.data("processing",!0),h.data("processing",!0);var i;c.get_string("admin:processingdots","local_onlineappraisal").done(function(b){i=a('<i class="fa fa-2x fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+b+"</span>"),g.hide().after(i)}).fail(d.exception);var j=f.find("td").length,k=a('<tr class="tr-alert"><td colspan="'+j+'"><div class="alert" role="alert"></div></td></tr>').hide(),l=k.find(".alert"),m=f.data("appraisalid");c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"index",a:"toggle_f2f_complete",appraisalid:m},success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?(l.removeClass("alert-danger").addClass("alert-success"),g.toggleClass("fa-square-o",!b.data).toggleClass("fa-check-square",b.data).data("processing",!1).show(),b.data?h.html(h.data("notcomplete")):h.html(h.data("complete")),h.data("processing",!1),i.remove()):(l.removeClass("alert-success").addClass("alert-danger"),i.remove(),g.data("processing",!1).show(),h.data("processing",!1)),l.html(b.message),f.next(".tr-alert").remove(),k.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},error:function(){l.removeClass("alert-success").addClass("alert-danger"),l.html(c),f.next(".tr-alert").remove(),k.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),i.remove(),g.data("processing",!1).show(),h.data("processing",!1)}})}).fail(d.exception)}}),a(".oa-f2f-edit").click(function(){var b=a(this),c=b.closest("tr"),d="#oa-f2f-date-"+c.data("appraisalid"),g=a(d),h=g.siblings("span");if(b.data("clicked"))return void g.datepicker("show");if(b.data("clicked",!0),b.siblings(".oa-f2f-save, .oa-f2f-undo").removeClass("hidden").show(),g.datepicker({autoclose:!0,format:{toDisplay:function(a,b,c){return e.toDisplay(a,b.format,c)},toValue:function(a,b,c,d){return e.toValue(a,b.format,c,d)},format:f.dateformat},startDate:0,todayHighlight:!0,zIndexOffset:1030,language:a("html").prop("lang").replace("-","_")}).on("changeDate",function(a){h.html(a.format())}),g.data("y")&&g.data("m")&&g.data("d")){var i=new Date(g.data("y"),g.data("m")-1,g.data("d"));g.datepicker("update",i)}g.datepicker("show")}),a(".oa-f2f-undo").click(function(){var b=a(this),c=b.closest("tr"),d="#oa-f2f-date-"+c.data("appraisalid"),e=a(d),f=e.siblings("span");if(b.hide(),b.siblings(".oa-f2f-save").hide(),b.siblings(".oa-f2f-edit").data("clicked",!1),e.data("y")&&e.data("m")&&e.data("d")){var g=new Date(e.data("y"),e.data("m")-1,e.data("d"));e.datepicker("update",g),f.html(e.datepicker("getFormattedDate"))}else e.datepicker("update",""),f.html("-");e.datepicker("destroy")}),a(".oa-f2f-save").click(function(){var e=a(this),f=e.closest("tr"),g="#oa-f2f-date-"+f.data("appraisalid"),h=a(g),i=f.find("td").length,j=a('<tr class="tr-alert"><td colspan="'+i+'"><div class="alert" role="alert"></div></td></tr>').hide(),k=j.find(".alert"),l=e.html();e.prop("disabled",!0),c.get_string("admin:savingdots","local_onlineappraisal").done(function(a){e.html('<i class="fa fa-lg fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+a+"</span>")}).fail(d.exception);var m=f.data("appraisalid"),n=h.datepicker("getUTCDate");return"[object Date]"!==Object.prototype.toString.call(n)?void c.get_string("error:f2fdate","local_onlineappraisal").done(function(b){k.removeClass("alert-success").addClass("alert-danger"),k.html(b),f.next(".tr-alert").remove(),j.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),e.html(l),e.prop("disabled",!1),e.blur()}).fail(d.exception):void c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"index",a:"update_f2f_date",appraisalid:m,date:n.getTime()/1e3},success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?(k.removeClass("alert-danger").addClass("alert-success"),e.hide(),e.siblings(".oa-f2f-undo").hide(),e.siblings(".oa-f2f-edit").data("clicked",!1),h.data("d",n.getDate()),h.data("m",n.getMonth()+1),h.data("y",n.getFullYear()),h.datepicker("destroy")):k.removeClass("alert-success").addClass("alert-danger"),k.html(b.message),f.next(".tr-alert").remove(),j.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},error:function(){k.removeClass("alert-success").addClass("alert-danger"),k.html(c),f.next(".tr-alert").remove(),j.insertAfter(f).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},complete:function(){e.html(l),e.prop("disabled",!1),e.blur()}})}).fail(d.exception)}),a("i.oa-togglesuccessionplan").css("cursor","pointer"),a(".oa-togglesuccessionplan.disabled").css("cursor","not-allowed"),a(".oa-togglesuccessionplan").click(function(e){e.preventDefault();var f=a(this);if(!a(this).data("processing")&&!a(this).hasClass("disabled")){var g=a(this).closest("tr");f.data("processing",!0);var h;c.get_string("admin:processingdots","local_onlineappraisal").done(function(b){h=a('<i class="fa fa-2x fa-fw fa-spinner fa-spin"></i><span class="sr-only">'+b+"</span>"),f.hide().after(h)}).fail(d.exception);var i=g.find("td").length,j=a('<tr class="tr-alert"><td colspan="'+i+'"><div class="alert" role="alert"></div></td></tr>').hide(),k=j.find(".alert"),l=f.data("appraisalid"),m=f.data("confirm");"undefined"==typeof m&&(m=0),f.removeData("confirm"),c.get_string("error:request","local_onlineappraisal").done(function(c){a.ajax({type:"POST",url:b.wwwroot+"/local/onlineappraisal/ajax.php?sesskey="+b.sesskey,data:{c:"index",a:"toggle_successionplan",appraisalid:l,confirm:m},success:function(b){"object"!=typeof b&&(b={success:!1,message:c,data:""}),b.success?(k.removeClass("alert-danger").addClass("alert-success"),f.toggleClass("fa-square-o",!b.data).toggleClass("fa-check-square",b.data).data("processing",!1).show(),h.remove()):(k.removeClass("alert-success").addClass("alert-danger"),h.remove(),f.data("processing",!1).show()),k.html(b.message),g.next(".tr-alert").remove(),"confirm"===b.data?j.insertAfter(g).slideDown():j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()})},error:function(){k.removeClass("alert-success").addClass("alert-danger"),k.html(c),g.next(".tr-alert").remove(),j.insertAfter(g).slideDown().delay(5e3).slideUp(function(){a(this).remove()}),h.remove(),f.data("processing",!1).show()}})}).fail(d.exception)}}),a("table").on("click",".oa-togglesuccessionplan-confirm",function(b){b.preventDefault();var c=a(this),d=c.closest("tr");c.data("confirm")&&d.closest("table").find(".oa-togglesuccessionplan").filter(function(){return a(this).data("appraisalid")===c.data("appraisalid")}).data("confirm",1).click(),d.slideUp(function(){a(this).remove()})})}}});