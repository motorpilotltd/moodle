define(["jquery"],function(a){function b(b,c){var d=this;d.o=a.extend({},{target:"next",mode:"words",speed:"slow",truncate:10,ellipsis:"...",effect:"fade",controlBtn:"",showText:"Show more",hideText:"Hide text",showClass:"show-class",hideClass:"hide-class",atStart:"hide",lockHide:!1,dynamic:!1,changeText:!1,beforeShow:null,afterShow:null,beforeHide:null,afterHide:null},c),d.e=a(b),d.init()}return b.prototype={init:function(){var b=this;b.mode=b.o.mode,b.remaining={},b.ctrlHtml=' <a href="#" data-ctrl class="'+(a.isFunction(b.o.controlBtn)?"":b.o.controlBtn)+'"></a>',a(b.e).each(function(){a(this).data("oCnt",b.e.html());var c=a.isFunction(b.o.atStart)?b.o.atStart.call(b.e):b.o.atStart;c="undefined"!=typeof b.e.attr("data-start")?b.e.attr("data-start"):c,"hide"==c?b.hide(b.e,0):b.show(b.e,0)});var c;a(window).on("resize",function(){b.o.dynamic&&"lines"==b.mode&&(clearTimeout(c),c=setTimeout(function(){b.reInit(b.e)},100))})},show:function(b,c){var d=this,e=a(b);"undefined"==typeof c&&(c=d.o.speed);var f=function(){a.isFunction(d.o.afterShow)&&d.o.afterShow.call(d.e,d)};switch(a.isFunction(d.o.beforeShow)&&d.o.beforeShow.call(d.e,d),d.mode){case"chars":case"words":var g=e.height();e.html(e.data("tHTML"));var h=e.height();e.height(g),e.animate({height:h},c,function(){e.height("auto"),f()}).removeClass(d.o.hideClass).addClass(d.o.showClass),e.data("tHTML",e.html());break;case"lines":0==e.children("div").length&&e.wrapInner("<div>");var i=e.children("div"),j=i.height(),k=i.html(e.data("oCnt")).css("height","").height();i.css("height",j);i.animate({height:k},c,function(){i.height("auto"),f()}),e.removeClass(d.o.hideClass).addClass(d.o.showClass);break;case"block":d.blockMode(e,"show",c,f)}return d.status=1,1==d.o.lockHide?(e.find("[data-ctrl]").remove(),""):void("block"==d.mode?e.off("click.coll").on("click.coll",function(a){a.preventDefault(),d.hide(e)}):(0!=e.find("[data-ctrl]").length||a.isFunction(d.o.controlBtn)||e.append(d.ctrlHtml),d.ctrlBtn=a.isFunction(d.o.controlBtn)?d.o.controlBtn.call(d.e):a(e.find("[data-ctrl]")),d.ctrlBtn.off("click.coll").on("click.coll",function(a){a.preventDefault(),d.hide(e)}).html(d.o.hideText)))},hide:function(b,c){var d=this,e=a(b);"undefined"==typeof c&&(c=d.o.speed);var f=function(){a.isFunction(d.o.afterHide)&&d.o.afterHide.call(d.e,d)};switch(a.isFunction(d.o.beforeHide)&&d.o.beforeHide.call(d.e,d),e.find("[data-ctrl]").remove(),d.mode){case"chars":var g=a.trim(e.text());d.remaining.chars=g.length-d.o.truncate,g.length>d.o.truncate&&(e.data("tHTML",e.html()),g=d.pad(g.slice(0,d.o.truncate),g.slice(d.o.truncate,g.length)),e.html(g).removeClass(d.o.showClass).addClass(d.o.hideClass),f());break;case"words":var g=a.trim(e.text()),h=g.split(" ");d.remaining.words=h.length-d.o.truncate,h.length>d.o.truncate&&(e.data("tHTML",e.html()),g=d.pad(h.slice(0,d.o.truncate).join(" "),h.slice(d.o.truncate,h.length).join(" ")),e.html(g).removeClass(d.o.showClass).addClass(d.o.hideClass),f());break;case"lines":0==e.children("div").length&&e.wrapInner("<div>");var i=e.children("div").css("height","");i.html(i.text());var j=i.height();"undefined"==typeof e.data("lHeight")?(temp=i.clone(),lHeight=temp.text("a").insertAfter(i).height(),e.data("lHeight",lHeight),i.next().remove()):lHeight=e.data("lHeight"),lines=j/lHeight,d.remaining.lines=lines-d.o.truncate,d.remaining.lines>0&&(i.css("overflow","hidden"),i.animate({height:lHeight*d.o.truncate},c).data("tHeight",j),e.removeClass(d.o.showClass).addClass(d.o.hideClass),0!=e.find("[data-ctrl]").length||a.isFunction(d.o.controlBtn)||e.append(d.ctrlHtml),f());break;case"block":d.blockMode(e,"hide",c,f)}if(d.status=0,"block"==d.mode)e.unbind("click.coll").bind("click.coll",function(a){a.preventDefault(),d.show(e)});else{d.ctrlBtn=a.isFunction(d.o.controlBtn)?d.o.controlBtn.call(d.e):a(e.find("[data-ctrl]")),d.ctrlBtn.off("click.coll").on("click.coll",function(a){a.preventDefault(),d.show(e)}).html(d.o.showText);var k=d.o.showText,l={chars:["character","characters"],words:["word","words"],lines:["lines","lines"]},m=d.remaining[d.mode]+(1==d.remaining[d.mode]?" "+l[d.mode][0]:" "+l[d.mode][1]);k=k.replace("%s",m),d.ctrlBtn.html(k)}},pad:function(b,c){var d=this;return b+'<span class="coll-ellipsis">'+d.o.ellipsis+"</span>"+(a.isFunction(d.o.ctrlBtn)?"":d.ctrlHtml)+'<span class="coll-hidden" style="display:none">'+c+"</span>"},blockMode:function(b,c,d,e){var f=this,g=["fadeOut","slideUp","fadeIn","slideDown"],h="fade"==f.o.effect?0:1,i="hide"==c?g[h]:g[h+2];a.isFunction(f.o.target)?f.o.target.call(f.e)[i](d,e):a.fn[f.o.target]&&a(b)[f.o.target]()[i](d,e),"show"==c?(b.removeClass(f.o.showClass).addClass(f.o.hideClass),f.o.changeText&&b.text(f.o.hideText)):(b.removeClass(f.o.hideClass).addClass(f.o.showClass),f.o.changeText&&b.text(f.o.showText))},reInit:function(a){var b=this;a.find("[data-ctrl]").remove(),"chars"==b.mode,a.html(b.e.data("oCnt")),0==b.status?b.hide(a,0):b.show(a,0)}},{extend:function(){var c="collapser";a.fn[c]=function(d){return this.each(function(){a.data(this,c)||a.data(this,c,new b(this,d))})}}}});