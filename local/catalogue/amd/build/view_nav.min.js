define(["jquery","core/custom_interaction_events","core/log","local_catalogue/view","local_catalogue/selectors"],function(a,b,c,d,e){var f={FILTERS:'[data-region="filter"]',METADATA:'[data-region="metadata"]',CAT:'[data-region="select-category"]',SELECT_CAT:'[data-action="select-category"]',CAT_CONTAINER:".categories-container",SEARCH_CONTAINER:'[data-region="search-container"]',SEARCH:'[data-action="search-catalogue"]',SEARCH_BUTTON:'[data-action="search-button"]',SELECT_FILTER:'[data-action="select-filter"]',FILTER_OPTION:"[data-filter]",DISPLAY:'[data-region="select-display"]',DISPLAY_OPTION:"[data-display-option]",SELECT_BTN:"#selectcategorydropdown",CATACTIONS:'[data-region="catactions"]',FILTERS_BTN:'[data-action="showfilters"]',FILTERS_CONTAINER:'[data-region="catfilters"]',FILTERS_ACTIVE:'[data-region="filtersactive"]',CLOSE_FILTERS_BTN:'[data-action="close-filters"]',SUBCATEGORY_FILTERS:'[data-region="subcategoryfilters"]',LOAD_MORE:'[data-action="loadmore"]',EXPAND_FILTERS:'[data-action="expand"]',COLLAPSE_FILTERS:'[data-action="collapse"]'},g=function(b){var d=b.find(e.courseView.region),g=d.attr("data-metadata");if("[{}]"===g)try{g=localStorage.getItem("data-metadata")}catch(h){c.debug(h)}var i=[];try{i=JSON.parse(g)}catch(h){d.attr("data-metadata","[{}]");try{localStorage.setItem("data-metadata","[{}]")}catch(h){c.debug(h)}}i&&i.forEach(function(a){var c=b.find('[data-type="'+a.type+'"][data-value="'+a.value+'"]');c.prop("checked",!0),c.addClass("active"),c.closest(".custom-control").addClass("show"),c.closest(".filter-types").addClass("showcollapsed")});var j="";try{j=localStorage.getItem("data-display")}catch(h){c.debug(h)}if(j){var k=b.find(f.DISPLAY);k.find(f.DISPLAY_OPTION).each(function(b,c){var d=a(c);d.removeClass("active"),d.removeClass("btn-secondary"),d.addClass("btn-outline-secondary"),d.attr("data-pref")==j&&(d.removeClass("btn-outline-secondary"),d.addClass("active"),d.addClass("btn-secondary"))})}},h=function(a){var b=a.find(f.SEARCH);if(localStorage.getItem("data-search")){var c=localStorage.getItem("data-search");b.val(c)}},i=function(c){var g=c.find(f.METADATA);b.define(g,[b.events.activate]),g.on(b.events.activate,f.SELECT_FILTER,function(b){var g=a(b.target);g.hasClass("active")?(g.removeClass("active"),g.closest(".custom-control").removeClass("show"),g.closest(".filter-types").find(".custom-control.show").length||g.closest(".filter-types").removeClass("showcollapsed")):(g.addClass("active"),g.closest(".custom-control").addClass("show"),g.closest(".filter-types").hasClass("forced")||g.closest(".filter-types").addClass("showcollapsed"));var h=[],i=!1;c.find(f.SELECT_FILTER).each(function(b,c){var d=a(c);if(d.hasClass("active")){var e={type:d.attr("data-type"),value:d.attr("data-value")};h.push(e),i=!0}});var j=c.find(e.courseView.region),k=JSON.stringify(h);j.attr("data-metadata",k),i?c.find(f.FILTERS_ACTIVE).removeClass("hidden"):c.find(f.FILTERS_ACTIVE).addClass("hidden"),localStorage.setItem("data-metadata",k);var l=M.cfg.wwwroot+"/local/catalogue/index.php?showcatid="+j.attr("data-category")+"&page=incatalogue";history.replaceState&&history.replaceState(null,null,l),d.init(c)}),g.on(b.events.activate,f.COLLAPSE_FILTERS,function(b,c){var d=a(b.target);d.closest(".filter-types").addClass("showcollapsed"),d.closest(".filter-types").addClass("forced"),c.originalEvent.preventDefault()}),g.on(b.events.activate,f.EXPAND_FILTERS,function(b,c){var d=a(b.target);d.closest(".filter-types").removeClass("showcollapsed"),d.closest(".filter-types").addClass("forced"),c.originalEvent.preventDefault()}),b.define(c,[b.events.activate]),c.on(b.events.activate,f.FILTERS_BTN,function(){h.addClass("showfilters")});var h=c.find(f.FILTERS_CONTAINER);b.define(h,[b.events.activate]),h.on(b.events.activate,f.CLOSE_FILTERS_BTN,function(){h.removeClass("showfilters")});var i=c.find(f.SUBCATEGORY_FILTERS);b.define(i,[b.events.activate]),i.on(b.events.activate,f.LOAD_MORE,function(a,b){i.removeClass("subcatshowsubset"),b.originalEvent.preventDefault()});var j=c.find(f.DISPLAY);b.define(j,[b.events.activate]),j.on(b.events.activate,f.DISPLAY_OPTION,function(b,g){var h=a(b.target).closest(f.DISPLAY_OPTION);j.find(f.DISPLAY_OPTION).each(function(b,c){a(c).removeClass("active"),a(c).removeClass("btn-secondary"),a(c).addClass("btn-outline-secondary")}),h.removeClass("btn-outline-secondary"),h.addClass("active"),h.addClass("btn-secondary");var i=h.attr("data-pref");c.find(e.courseView.region).attr("data-display",i),localStorage.setItem("data-display",i),d.init(c),g.originalEvent.preventDefault()});var k=c.find(f.SEARCH_CONTAINER);b.define(k,[b.events.activate,b.events.enter]),k.on(b.events.enter,f.SEARCH,function(b,f){var g=a(b.target),h=c.find(e.courseView.region),i=g.val();h.attr("data-search",i),localStorage.setItem("data-search",i),g.prop("disabled",!0),d.init(c),f.originalEvent.preventDefault()}),k.on(b.events.activate,f.SEARCH_BUTTON,function(a,b){var g=c.find(f.SEARCH),h=c.find(e.courseView.region),i=g.val();h.attr("data-search",i),d.init(c),b.originalEvent.preventDefault()})},j=function(b){b=a(b),g(b),h(b),i(b)};return{init:j}});