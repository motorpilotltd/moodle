define(["jquery","core/templates","core/notification","local_catalogue/pubsub","local_catalogue/paged_content_events"],function(a,b,c,d,e){var f={ROOT:'[data-region="page-container"]',PAGE_REGION:'[data-region="paged-content-page"]',ACTIVE_PAGE_REGION:'[data-region="paged-content-page"].active'},g={PAGING_CONTENT_ITEM:"local_catalogue/paged_content_page",LOADING:"core/overlay_loading"},h=300,i=function(a,b){return a.find('[data-page="'+b+'"]')},j=function(d){var e=a.Deferred();return d.attr("aria-busy",!0),d.addClass("loading"),b.render(g.LOADING,{visible:!0}).then(function(b){var c=a(b),f=setTimeout(function(){d.css("position","relative"),c.appendTo(d)},h);e.always(function(){clearTimeout(f),c.remove(),d.css("position",""),d.removeAttr("aria-busy"),d.removeClass("loading")})}).fail(c.exception),e},k=function(d,e,f){var h=a.Deferred();return e.then(function(a,e){e=e||"",b.render(g.PAGING_CONTENT_ITEM,{page:f,content:a}).then(function(a){b.appendNodeContents(d,a,e);var c=i(d,f);h.resolve(c)}).fail(function(a){h.reject(a)}).fail(c.exception)}).fail(function(a){h.reject(a)}).fail(c.exception),h.promise()},l=function(b,f,g,h){var l=[],m=[],n=a.Deferred();if(f.forEach(function(a){var c=a.pageNumber,d=i(b,c);d.length?l.push(d):m.push(a)}),m.length&&"function"==typeof h){var o=h(m,{allItemsLoaded:function(a){d.publish(g+e.ALL_ITEMS_LOADED,a)}}),p=o.map(function(a,c){return k(b,a,m[c].pageNumber)});a.when.apply(a,p).then(function(){var a=Array.prototype.slice.call(arguments);n.resolve(a)}).fail(function(a){n.reject(a)}).fail(c.exception)}else n.resolve([]);var q=j(b);1==f[0].pageNumber&&d.publish(g+e.START_LOADING,f),n.then(function(a){var b=l.concat(a);b.forEach(function(a){a.removeClass("hidden")})}).then(function(){d.publish(g+e.PAGES_SHOWN,f)}).fail(c.exception).always(function(){q.resolve()})},m=function(b,c,f){b=a(b),d.subscribe(c+e.SHOW_PAGES,function(a){1==a[0].pageNumber?(b.attr("subscribed")||l(b,a,c,f),b.attr("subscribed",!0)):(b.attr("subscribed",!1),l(b,a,c,f))}),d.subscribe(c+e.SET_ITEMS_PER_PAGE_LIMIT,function(){b.empty()})};return{init:m,rootSelector:f.ROOT}});