define(["jquery","local_catalogue/repository"],function(a,b){var c=function(b,c,d){var e=M.util.get_string("closebuttontitle","moodle");a(c).length||b.find("#snap-coverimagecontrol").before('<div id="'+c+'" class="alert alert-warning" role="alert">'+d+'<button type="button" class="close" data-dismiss="alert" aria-label="'+e+'"><span aria-hidden="true">&times;</span></button></div>')},d=function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]},e=function(a){a.find("#snap-alert-cover-image-size").remove(),a.find("#snap-alert-cover-image-bytes").remove(),a.find("#snap-changecoverimageconfirmation").removeClass("state-visible"),a.find('label[for="snap-coverfiles"]').addClass("state-visible"),a.find("#snap-coverfiles").val("")},f=function(a){a.find("#snap-alert-cover-image-upload-failed").remove(),a.find("#snap-changecoverimageconfirmation").removeClass("disabled"),a.find('label[for="snap-coverfiles"]').removeClass("state-visible"),a.find("#snap-changecoverimageconfirmation").addClass("state-visible")},g=function(g,h,i){g.data("servercoverfile",g.css("background-image")),g.find("#changecoverimage").click(function(b){b.preventDefault(),a(this).removeClass("state-visible"),g.find('label[for="snap-coverfiles"]').addClass("state-visible")});var j,k;g.find("#snap-coverfiles").on("change",function(b){var i=b.target.files;if(i.length&&(j=i[0],j.type.match("image.*"))){var l=new FileReader;g.find('label[for="snap-coverfiles"]').addClass("ajaxing"),l.onload=function(b){return function(i){k=i.target.result,g.addClass("mast-image");var j=h;if(b.size>j){e();var l=d(j),m=M.util.get_string("error:coverimageexceedsmaxbytes","local_catalogue",l);return void c(g,"snap-alert-cover-image-bytes",m)}g.find("#snap-alert-cover-image-bytes").remove();var n=a("<img />");n=n.get(0),n.src=k,a(n).on("load",function(){n.width<400?c(g,"snap-alert-cover-image-size",M.util.get_string("error:coverimageresolutionlow","local_catalogue")):g.find("#snap-alert-cover-image-size").remove()}),g.css("background-image","url("+k+")"),g.data("localcoverfile",b.name),f(g)}}(j),l.readAsDataURL(j)}}),g.find("#snap-changecoverimageconfirmation .ok").click(function(c){if(!a(this).parent().hasClass("disabled")){c.preventDefault(),g.find("#snap-alert-cover-image-size").remove(),g.find("#snap-alert-cover-image-bytes").remove(),g.find("#snap-changecoverimageconfirmation .ok").addClass("ajaxing"),g.find("#snap-changecoverimageconfirmation").addClass("disabled");var d=k.split("base64,")[1];i.imagedata=d,i.imagefilename=j.name,b.saveCategoryImage({params:i}).then(function(a){a.success&&e(g)})}}),g.find("#snap-changecoverimageconfirmation .cancel").click(function(){a(this).parent().hasClass("disabled")||(g.css("background-image",g.data("servercoverfile")),e(g))}),g.find("#snap-coverimagecontrol").addClass("snap-js-enabled")},h=function(a,b){var c={imagefilename:null,imagedata:null,categoryid:a.attr("data-categoryid")};g(a,b,c)};return{categoryImage:h}});